-- Below Script files are changed

CONScripts.sql
FMSScripts.sql
MAGScripts.sql
PMSScripts.sql
VendorScripts.sql

psql -d checkbook_mwbe -f VendorScripts.sql 1>1.out 2>2.err
psql -d checkbook_mwbe -f MAGScripts.sql 1>1.out 2>2.err
psql -d checkbook_mwbe -f CONScripts.sql 1>1.out 2>2.err
psql -d checkbook_mwbe -f FMSScripts.sql 1>1.out 2>2.err
psql -d checkbook_mwbe -f PMSScripts.sql 1>1.out 2>2.err
psql -d checkbook_mwbe -f PendingContracts.sql 1>1.out 2>2.err

-- Aggregate table scripts changed

---- start industry type reclassification changes ----

INSERT INTO ref_award_category(award_category_code, award_category_name, created_date) values('028','CULTURAL RELATED SERVICES',now()::timestamp),('029','ECONOMIC DEVELOPMENT',now()::timestamp);
UPDATE ref_award_category SET  created_date = now()::timestamp where award_category_code in ('028','029');


INSERT INTO ref_award_category_industry(award_category_code, industry_type_id, created_date) SELECT '028' as award_category_code, industry_type_id, now()::timestamp from ref_industry_type where industry_type_name = 'Standardized Services'  ;
INSERT INTO ref_award_category_industry(award_category_code, industry_type_id, created_date) SELECT '029' as award_category_code, industry_type_id, now()::timestamp from ref_industry_type where industry_type_name = 'Standardized Services' ;
UPDATE ref_award_category_industry SET  created_date = now()::timestamp where award_category_code in ('028','029');


update ref_award_category_industry a 
set industry_type_id = b.industry_type_id
FROM ref_industry_type b
WHERE a.award_category_code in ('023','200','888') AND b.industry_type_name = 'Professional Services' ;


update ref_award_category_industry a 
set industry_type_id = b.industry_type_id
FROM ref_industry_type b
WHERE a.award_category_code in ('035','040') AND b.industry_type_name = 'Standardized Services' ;


update ref_award_category_industry a 
set industry_type_id = b.industry_type_id
FROM ref_industry_type b
WHERE a.award_category_code in ('041','042','043','050','051','052','054','055','056','057','058','059','060','061','062','063','064','065','066','067','068','100','101','102','103') 
AND b.industry_type_name = 'Human Services' ;

update ref_award_category_industry a 
set industry_type_id = b.industry_type_id
FROM ref_industry_type b
WHERE a.award_category_code in ('099' ) AND b.industry_type_name = 'Not Classified' ;


UPDATE 	agreement_snapshot a 
SET  industry_type_id = b.industry_type_id,
    industry_type_name = b.industry_type_name	
	FROM (SELECT a.agreement_id, (CASE WHEN a.agreement_type_code in ('51','70') AND a.award_category_code = '23' THEN 3 
      WHEN a.agreement_type_code = '70' AND a.award_category_code in ('30','40') THEN 4
      WHEN a.agreement_type_code = '70' THEN 6
	  WHEN a.agreement_type_code in ('05','48','52') THEN 1
	  WHEN a.agreement_type_code in ('46','51','81','82') THEN 2
	  ELSE k.industry_type_id END) as industry_type_id,
	  (CASE WHEN a.agreement_type_code in ('51','70') AND a.award_category_code = '23' THEN 'Professional Services' 
      WHEN a.agreement_type_code = '70' AND a.award_category_code in ('30','40') THEN 'Standardized Services'
      WHEN a.agreement_type_code = '70' THEN 'Human Services'
	  WHEN a.agreement_type_code in ('05','48','52') THEN 'Construction Services'
	  WHEN a.agreement_type_code in ('46','51','81','82') THEN 'Goods'
		ELSE l.industry_type_name END) as  industry_type_name
FROM agreement_snapshot a LEFT JOIN ref_award_category_industry k ON k.award_category_code = a.award_category_code 
		LEFT JOIN ref_industry_type l ON k.industry_type_id = l.industry_type_id ) b
WHERE a.agreement_id = b.agreement_id ;

UPDATE 	agreement_snapshot_cy a 
SET  industry_type_id = b.industry_type_id,
    industry_type_name = b.industry_type_name	
	FROM (SELECT a.agreement_id, (CASE WHEN a.agreement_type_code in ('51','70') AND a.award_category_code = '23' THEN 3 
      WHEN a.agreement_type_code = '70' AND a.award_category_code in ('30','40') THEN 4
      WHEN a.agreement_type_code = '70' THEN 6
	  WHEN a.agreement_type_code in ('05','48','52') THEN 1
	  WHEN a.agreement_type_code in ('46','51','81','82') THEN 2
	  ELSE k.industry_type_id END) as industry_type_id,
	  (CASE WHEN a.agreement_type_code in ('51','70') AND a.award_category_code = '23' THEN 'Professional Services' 
      WHEN a.agreement_type_code = '70' AND a.award_category_code in ('30','40') THEN 'Standardized Services'
      WHEN a.agreement_type_code = '70' THEN 'Human Services'
	  WHEN a.agreement_type_code in ('05','48','52') THEN 'Construction Services'
	  WHEN a.agreement_type_code in ('46','51','81','82') THEN 'Goods'
		ELSE l.industry_type_name END) as  industry_type_name
FROM agreement_snapshot_cy a LEFT JOIN ref_award_category_industry k ON k.award_category_code = a.award_category_code 
		LEFT JOIN ref_industry_type l ON k.industry_type_id = l.industry_type_id ) b
WHERE a.agreement_id = b.agreement_id ;



---- end industry type reclassification changes -----


TRUNCATE etl.aggregate_tables;
COPY etl.aggregate_tables FROM '/home/gpadmin/TREDDY/MWBE/CREATE_NEW_DATABASE/widget_aggregate_tables.csv' CSV HEADER QUOTE as '"';
COPY etl.aggregate_tables FROM '/home/gpadmin/TREDDY/MWBE/CREATE_NEW_DATABASE/widget_aggregate_tables_mwbe.csv' CSV HEADER QUOTE as '"';
COPY etl.aggregate_tables FROM '/home/gpadmin/TREDDY/MWBE/CREATE_NEW_DATABASE/widget_aggregate_tables_subcontracts.csv' CSV HEADER QUOTE as '"';



-- Vendor Script Changes

DROP TABLE IF EXISTS vendor_min_bus_type;

CREATE TABLE vendor_min_bus_type
( vendor_id integer,
  vendor_history_id integer,
  business_type_id smallint,
  minority_type_id smallint,
  business_type_code character varying(4),
  business_type_name character varying(50),
  minority_type_name character varying(50)
)
DISTRIBUTED BY (vendor_history_id);

INSERT INTO vendor_min_bus_type(vendor_id, vendor_history_id, business_type_id, minority_type_id, business_type_code, business_type_name, minority_type_name ) 
SELECT d.vendor_id, a.vendor_history_id, a.business_type_id as business_type_id,
		(case when a.business_type_id = 2 then 11   when a.business_type_id = 5 then 9 else a.minority_type_id end) as minority_type_id,
		c.business_type_code as business_type_code, 	c.business_type_name as business_type_name,
		(case when a.business_type_id = 2 then 'Individuals & Others' when a.business_type_id = 5 then 'Caucasian Woman'  else b.minority_type_name end) as minority_type_name
FROM
(SELECT vendor_history_id , business_type_id ,minority_type_id 
FROM vendor_business_type 
WHERE status =2 AND (business_type_id=2 or minority_type_id is not null or (vendor_history_id in 
(SELECT DISTINCT vendor_history_id 
FROM vendor_business_type  WHERE  business_type_id = 5 AND status = 2 AND vendor_history_id not in 
(SELECT DISTINCT vendor_history_id FROM vendor_business_type WHERE minority_type_id is not null AND status = 2)) AND business_type_id=5))) a 
LEFT JOIN ref_minority_type b ON a.minority_type_id = b.minority_type_id 
LEFT JOIN ref_business_type c ON a.business_type_id = c.business_type_id
LEFT JOIN vendor_history d ON a.vendor_history_id = d.vendor_history_id;


-- Contracts Script Changes

 -- scripts for agreement_snapshot
 
 
DROP TABLE IF EXISTS agreement_snapshot_mwbe;
DROP TABLE IF EXISTS agreement_snapshot_backup;

CREATE TABLE agreement_snapshot_mwbe as select * from agreement_snapshot;
CREATE TABLE agreement_snapshot_backup as select * from agreement_snapshot;

DROP TABLE IF EXISTS agreement_snapshot CASCADE;

CREATE TABLE agreement_snapshot
 (
   original_agreement_id bigint,
   document_version smallint,
   document_code_id smallint,
   agency_history_id smallint,
   agency_id smallint,
   agency_code character varying(20),
   agency_name character varying(100),
   agreement_id bigint,
   starting_year smallint,
   starting_year_id smallint,
   ending_year smallint,
   ending_year_id smallint,
   registered_year smallint,
   registered_year_id smallint,
   contract_number character varying,
   original_contract_amount numeric(16,2),
   maximum_contract_amount numeric(16,2),
   description character varying,
   vendor_history_id integer,
   vendor_id integer,
   vendor_code character varying(20),
   vendor_name character varying,
   dollar_difference numeric(16,2),
   percent_difference numeric(17,4),
   master_agreement_id bigint,
   master_contract_number character varying,
   agreement_type_id smallint,
   agreement_type_code character varying(2),
   agreement_type_name character varying,
   award_category_id smallint,
   award_category_code character varying(10),
   award_category_name character varying,
   award_method_id smallint,
   award_method_code character varying(10) ,
   award_method_name character varying,
   expenditure_object_codes character varying,
   expenditure_object_names character varying,
   industry_type_id smallint,
   industry_type_name character varying(50),
   award_size_id smallint,
   effective_begin_date date,
   effective_begin_date_id integer,
   effective_begin_year smallint,
   effective_begin_year_id smallint,
   effective_end_date date,
   effective_end_date_id integer,
   effective_end_year smallint,
   effective_end_year_id smallint,
   registered_date date,
   registered_date_id integer,
   brd_awd_no character varying,
   tracking_number character varying,
   rfed_amount numeric(16,2),
    minority_type_id smallint,
 	minority_type_name character varying(50),
   master_agreement_yn character(1),  
   has_children character(1),
   original_version_flag character(1),
   latest_flag character(1),
   load_id integer,
   last_modified_date timestamp without time zone,
   job_id bigint
 ) DISTRIBUTED BY (original_agreement_id);
 

 INSERT INTO agreement_snapshot(
            original_agreement_id, document_version, document_code_id, agency_history_id, 
            agency_id, agency_code, agency_name, agreement_id, starting_year, 
            starting_year_id, ending_year, ending_year_id, registered_year, 
            registered_year_id, contract_number, original_contract_amount, 
            maximum_contract_amount, description, vendor_history_id, vendor_id, 
            vendor_code, vendor_name, dollar_difference, percent_difference, 
            master_agreement_id, master_contract_number, agreement_type_id, 
            agreement_type_code, agreement_type_name, award_category_id, 
            award_category_code, award_category_name, award_method_id, award_method_code, 
            award_method_name, expenditure_object_codes, expenditure_object_names, 
            industry_type_id, industry_type_name, award_size_id, effective_begin_date, 
            effective_begin_date_id, effective_begin_year, effective_begin_year_id, 
            effective_end_date, effective_end_date_id, effective_end_year, 
            effective_end_year_id, registered_date, registered_date_id, brd_awd_no, 
            tracking_number, rfed_amount, master_agreement_yn, has_children, 
            original_version_flag, latest_flag, load_id, last_modified_date, 
            job_id)
    SELECT original_agreement_id, document_version, document_code_id, agency_history_id, 
            agency_id, agency_code, agency_name, agreement_id, starting_year, 
            starting_year_id, ending_year, ending_year_id, registered_year, 
            registered_year_id, contract_number, original_contract_amount, 
            maximum_contract_amount, description, vendor_history_id, vendor_id, 
            vendor_code, vendor_name, dollar_difference, percent_difference, 
            master_agreement_id, master_contract_number, agreement_type_id, 
            agreement_type_code, agreement_type_name, award_category_id, 
            award_category_code, award_category_name, award_method_id, award_method_code, 
            award_method_name, expenditure_object_codes, expenditure_object_names, 
            industry_type_id, industry_type_name, award_size_id, effective_begin_date, 
            effective_begin_date_id, effective_begin_year, effective_begin_year_id, 
            effective_end_date, effective_end_date_id, effective_end_year, 
            effective_end_year_id, registered_date, registered_date_id, brd_awd_no, 
            tracking_number, rfed_amount, master_agreement_yn, has_children, 
            original_version_flag, latest_flag, load_id, last_modified_date, 
            job_id
	FROM agreement_snapshot_mwbe;
 
 DROP TABLE IF EXISTS agreement_snapshot_mwbe;
 
 UPDATE agreement_snapshot a
 SET minority_type_id = b.minority_type_id, 
	minority_type_name = b.minority_type_name
 FROM vendor_min_bus_type b
 WHERE a.vendor_history_id = b.vendor_history_id;
 
 	UPDATE agreement_snapshot a
	SET minority_type_id=11,
		minority_type_name = 'Individuals & Others'
	WHERE agreement_type_code IN ('35','36','39','40','44','65','68','79','85') 
	AND ( minority_type_id IS NULL OR minority_type_id IN (1,6,7,8));
	
	UPDATE agreement_snapshot a
	SET minority_type_id=11,
		minority_type_name = 'Individuals & Others'
	WHERE award_method_code IN ('07','08','09','17','18','44','45','55') 
	AND ( minority_type_id IS NULL OR minority_type_id IN (1,6,7,8));
	
	UPDATE agreement_snapshot a
	SET minority_type_id=7,
		minority_type_name = 'Non-Minority'
	WHERE ( minority_type_id IS NULL OR minority_type_id IN (1,6,7,8));
	
	
 -- scripts for agreement_snapshot_cy
 
 DROP TABLE IF EXISTS agreement_snapshot_cy_mwbe;
 DROP TABLE IF EXISTS agreement_snapshot_cy_backup;
 
CREATE TABLE agreement_snapshot_cy_mwbe as select * from agreement_snapshot_cy;
CREATE TABLE agreement_snapshot_cy_backup as select * from agreement_snapshot_cy;

DROP TABLE IF EXISTS agreement_snapshot_cy CASCADE;

CREATE TABLE agreement_snapshot_cy
 (
   original_agreement_id bigint,
   document_version smallint,
   document_code_id smallint,
   agency_history_id smallint,
   agency_id smallint,
   agency_code character varying(20),
   agency_name character varying(100),
   agreement_id bigint,
   starting_year smallint,
   starting_year_id smallint,
   ending_year smallint,
   ending_year_id smallint,
   registered_year smallint,
   registered_year_id smallint,
   contract_number character varying,
   original_contract_amount numeric(16,2),
   maximum_contract_amount numeric(16,2),
   description character varying,
   vendor_history_id integer,
   vendor_id integer,
   vendor_code character varying(20),
   vendor_name character varying,
   dollar_difference numeric(16,2),
   percent_difference numeric(17,4),
   master_agreement_id bigint,
   master_contract_number character varying,
   agreement_type_id smallint,
   agreement_type_code character varying(2),
   agreement_type_name character varying,
   award_category_id smallint,
   award_category_code character varying(10),
   award_category_name character varying,
   award_method_id smallint,
   award_method_code character varying(10) ,
   award_method_name character varying,
   expenditure_object_codes character varying,
   expenditure_object_names character varying,
   industry_type_id smallint,
   industry_type_name character varying(50),
   award_size_id smallint,
   effective_begin_date date,
   effective_begin_date_id integer,
   effective_begin_year smallint,
   effective_begin_year_id smallint,
   effective_end_date date,
   effective_end_date_id integer,
   effective_end_year smallint,
   effective_end_year_id smallint,
   registered_date date,
   registered_date_id integer,
   brd_awd_no character varying,
   tracking_number character varying,
   rfed_amount numeric(16,2),
    minority_type_id smallint,
 	minority_type_name character varying(50),
   master_agreement_yn character(1),  
   has_children character(1),
   original_version_flag character(1),
   latest_flag character(1),
   load_id integer,
   last_modified_date timestamp without time zone,
   job_id bigint
 ) DISTRIBUTED BY (original_agreement_id);
 
 
 INSERT INTO agreement_snapshot_cy(
            original_agreement_id, document_version, document_code_id, agency_history_id, 
            agency_id, agency_code, agency_name, agreement_id, starting_year, 
            starting_year_id, ending_year, ending_year_id, registered_year, 
            registered_year_id, contract_number, original_contract_amount, 
            maximum_contract_amount, description, vendor_history_id, vendor_id, 
            vendor_code, vendor_name, dollar_difference, percent_difference, 
            master_agreement_id, master_contract_number, agreement_type_id, 
            agreement_type_code, agreement_type_name, award_category_id, 
            award_category_code, award_category_name, award_method_id, award_method_code, 
            award_method_name, expenditure_object_codes, expenditure_object_names, 
            industry_type_id, industry_type_name, award_size_id, effective_begin_date, 
            effective_begin_date_id, effective_begin_year, effective_begin_year_id, 
            effective_end_date, effective_end_date_id, effective_end_year, 
            effective_end_year_id, registered_date, registered_date_id, brd_awd_no, 
            tracking_number, rfed_amount, master_agreement_yn, has_children, 
            original_version_flag, latest_flag, load_id, last_modified_date, 
            job_id)
    SELECT original_agreement_id, document_version, document_code_id, agency_history_id, 
            agency_id, agency_code, agency_name, agreement_id, starting_year, 
            starting_year_id, ending_year, ending_year_id, registered_year, 
            registered_year_id, contract_number, original_contract_amount, 
            maximum_contract_amount, description, vendor_history_id, vendor_id, 
            vendor_code, vendor_name, dollar_difference, percent_difference, 
            master_agreement_id, master_contract_number, agreement_type_id, 
            agreement_type_code, agreement_type_name, award_category_id, 
            award_category_code, award_category_name, award_method_id, award_method_code, 
            award_method_name, expenditure_object_codes, expenditure_object_names, 
            industry_type_id, industry_type_name, award_size_id, effective_begin_date, 
            effective_begin_date_id, effective_begin_year, effective_begin_year_id, 
            effective_end_date, effective_end_date_id, effective_end_year, 
            effective_end_year_id, registered_date, registered_date_id, brd_awd_no, 
            tracking_number, rfed_amount, master_agreement_yn, has_children, 
            original_version_flag, latest_flag, load_id, last_modified_date, 
            job_id
	FROM agreement_snapshot_cy_mwbe;
 
 DROP TABLE IF EXISTS agreement_snapshot_cy_mwbe;
 
 UPDATE agreement_snapshot_cy a
 SET minority_type_id = b.minority_type_id, 
	minority_type_name = b.minority_type_name
 FROM vendor_min_bus_type b
 WHERE a.vendor_history_id = b.vendor_history_id;
 
 	UPDATE agreement_snapshot_cy a
	SET minority_type_id=11,
		minority_type_name = 'Individuals & Others'
	WHERE agreement_type_code IN ('35','36','39','40','44','65','68','79','85') 
	AND ( minority_type_id IS NULL OR minority_type_id IN (1,6,7,8));
	
	UPDATE agreement_snapshot_cy a
	SET minority_type_id=11,
		minority_type_name = 'Individuals & Others'
	WHERE award_method_code IN ('07','08','09','17','18','44','45','55') 
	AND ( minority_type_id IS NULL OR minority_type_id IN (1,6,7,8));
	
	UPDATE agreement_snapshot_cy a
	SET minority_type_id=7,
		minority_type_name = 'Non-Minority'
	WHERE ( minority_type_id IS NULL OR minority_type_id IN (1,6,7,8));
 
 
  -- scripts for agreement_snapshot_expanded
  
DROP TABLE IF EXISTS agreement_snapshot_expanded_backup;

CREATE TABLE agreement_snapshot_expanded_backup as select * from agreement_snapshot_expanded;

DROP TABLE IF EXISTS agreement_snapshot_expanded;
  
 CREATE TABLE agreement_snapshot_expanded(
	original_agreement_id bigint,
	agreement_id bigint,
	fiscal_year smallint,
	description varchar,
	contract_number varchar,
	vendor_id int,
	agency_id smallint,
	industry_type_id smallint,
    award_size_id smallint,
	original_contract_amount numeric(16,2) ,
	maximum_contract_amount numeric(16,2),
	rfed_amount numeric(16,2),
	starting_year smallint,	
	ending_year smallint,
	dollar_difference numeric(16,2), 
	percent_difference numeric(17,4),
	award_method_id smallint,
	document_code_id smallint,
	master_agreement_id bigint,
	minority_type_id smallint,
 	minority_type_name character varying(50),
	master_agreement_yn character(1),
	status_flag char(1)
	)
DISTRIBUTED BY (original_agreement_id);	


DROP TABLE IF EXISTS agreement_snapshot_expanded_cy_backup;
CREATE TABLE agreement_snapshot_expanded_cy_backup as select * from agreement_snapshot_expanded_cy;

DROP TABLE IF EXISTS agreement_snapshot_expanded_cy;


CREATE TABLE agreement_snapshot_expanded_cy(
	original_agreement_id bigint,
	agreement_id bigint,
	fiscal_year smallint,
	description varchar,
	contract_number varchar,
	vendor_id int,
	agency_id smallint,
	industry_type_id smallint,
    award_size_id smallint,
	original_contract_amount numeric(16,2) ,
	maximum_contract_amount numeric(16,2),
	rfed_amount numeric(16,2),
	starting_year smallint,	
	ending_year smallint,
	dollar_difference numeric(16,2), 
	percent_difference numeric(17,4),
	award_method_id smallint,
	document_code_id smallint,
	master_agreement_id bigint,
	minority_type_id smallint,
 	minority_type_name character varying(50),
	master_agreement_yn character(1),
	status_flag char(1)
	)
DISTRIBUTED BY (original_agreement_id);	
 
 select etl.refreshContractsPreAggregateTables(max_job_id);
 
 
 
 -- FMS Script Changes
 
 DROP TABLE IF EXISTS disbursement_line_item_details_mwbe;
  DROP TABLE IF EXISTS disbursement_line_item_details_backup;
  
 
 CREATE TABLE disbursement_line_item_details_mwbe as select * from disbursement_line_item_details;
 
 CREATE TABLE disbursement_line_item_details_backup as select * from disbursement_line_item_details;
 
 DROP TABLE IF EXISTS disbursement_line_item_details CASCADE;
 
 CREATE TABLE disbursement_line_item_details(
	disbursement_line_item_id bigint,
	disbursement_id integer,
	line_number integer,
	disbursement_number character varying(40),
	check_eft_issued_date_id int,
	check_eft_issued_nyc_year_id smallint,
	fiscal_year smallint,
	check_eft_issued_cal_month_id int,
	agreement_id bigint,
	master_agreement_id bigint,
	fund_class_id smallint,
	check_amount numeric(16,2),
	agency_id smallint,
	agency_history_id smallint,
	agency_code varchar(20),
	expenditure_object_id integer,
	vendor_id integer,
	department_id integer,
	maximum_contract_amount numeric(16,2),
	maximum_contract_amount_cy numeric(16,2),
	maximum_spending_limit numeric(16,2),
	maximum_spending_limit_cy numeric(16,2),
	document_id varchar(20),
	vendor_name varchar,
	vendor_customer_code varchar(20), 
	check_eft_issued_date date,
	agency_name varchar(100),	
	agency_short_name character varying(15),  	
	location_name varchar,
	location_code varchar(4),
	department_name varchar(100),
	department_short_name character varying(15),
	department_code varchar(20),
	expenditure_object_name varchar(40),
	expenditure_object_code varchar(4),
	budget_code_id integer,
	budget_code varchar(10),
	budget_name varchar(60),
	contract_number varchar,
	master_contract_number character varying,
	master_child_contract_number character varying,
  	contract_vendor_id integer,
  	contract_vendor_id_cy integer,
  	master_contract_vendor_id integer,
  	master_contract_vendor_id_cy integer,
  	contract_agency_id smallint,
  	contract_agency_id_cy smallint,
  	master_contract_agency_id smallint,
  	master_contract_agency_id_cy smallint,
  	master_purpose character varying,
  	master_purpose_cy character varying,
	purpose varchar,
	purpose_cy varchar,
	master_child_contract_agency_id smallint,
	master_child_contract_agency_id_cy smallint,
	master_child_contract_vendor_id integer,
	master_child_contract_vendor_id_cy integer,
	reporting_code varchar(15),
	location_id integer,
	fund_class_name varchar(50),
	fund_class_code varchar(5),
	spending_category_id smallint,
	spending_category_name varchar,
	calendar_fiscal_year_id smallint,
	calendar_fiscal_year smallint,
	agreement_accounting_line_number integer,
	agreement_commodity_line_number integer,
	agreement_vendor_line_number integer, 
	reference_document_number character varying,
	reference_document_code varchar(8),
	contract_document_code varchar(8),
	master_contract_document_code varchar(8),
	minority_type_id smallint,
 	minority_type_name character varying(50),
 	industry_type_id smallint,
   	industry_type_name character varying(50),
   	agreement_type_code character varying(2),
   	award_method_code character varying(10),
   	contract_industry_type_id smallint,
	contract_industry_type_id_cy smallint,
	master_contract_industry_type_id smallint,
	master_contract_industry_type_id_cy smallint,
	contract_minority_type_id smallint,
	contract_minority_type_id_cy smallint,
	master_contract_minority_type_id smallint,
	master_contract_minority_type_id_cy smallint,
	file_type char(1),
	load_id integer,
	last_modified_date timestamp without time zone,
	job_id bigint
)
DISTRIBUTED BY (disbursement_line_item_id);


INSERT INTO disbursement_line_item_details(
            disbursement_line_item_id, disbursement_id, line_number, disbursement_number, 
            check_eft_issued_date_id, check_eft_issued_nyc_year_id, fiscal_year, 
            check_eft_issued_cal_month_id, agreement_id, master_agreement_id, 
            fund_class_id, check_amount, agency_id, agency_history_id, agency_code, 
            expenditure_object_id, vendor_id, department_id, maximum_contract_amount, 
            maximum_contract_amount_cy, maximum_spending_limit, maximum_spending_limit_cy, 
            document_id, vendor_name, vendor_customer_code, check_eft_issued_date, 
            agency_name, agency_short_name, location_name, location_code, 
            department_name, department_short_name, department_code, expenditure_object_name, 
            expenditure_object_code, budget_code_id, budget_code, budget_name, 
            contract_number, master_contract_number, master_child_contract_number, 
            contract_vendor_id, contract_vendor_id_cy, master_contract_vendor_id, 
            master_contract_vendor_id_cy, contract_agency_id, contract_agency_id_cy, 
            master_contract_agency_id, master_contract_agency_id_cy, master_purpose, 
            master_purpose_cy, purpose, purpose_cy, master_child_contract_agency_id, 
            master_child_contract_agency_id_cy, master_child_contract_vendor_id, 
            master_child_contract_vendor_id_cy, reporting_code, location_id, 
            fund_class_name, fund_class_code, spending_category_id, spending_category_name, 
            calendar_fiscal_year_id, calendar_fiscal_year, agreement_accounting_line_number, 
            agreement_commodity_line_number, agreement_vendor_line_number, 
            reference_document_number, reference_document_code, contract_document_code, 
            master_contract_document_code, file_type, load_id, last_modified_date, 
            job_id)
    SELECT disbursement_line_item_id, disbursement_id, line_number, disbursement_number, 
            check_eft_issued_date_id, check_eft_issued_nyc_year_id, fiscal_year, 
            check_eft_issued_cal_month_id, agreement_id, master_agreement_id, 
            fund_class_id, check_amount, agency_id, agency_history_id, agency_code, 
            expenditure_object_id, vendor_id, department_id, maximum_contract_amount, 
            maximum_contract_amount_cy, maximum_spending_limit, maximum_spending_limit_cy, 
            document_id, vendor_name, vendor_customer_code, check_eft_issued_date, 
            agency_name, agency_short_name, location_name, location_code, 
            department_name, department_short_name, department_code, expenditure_object_name, 
            expenditure_object_code, budget_code_id, budget_code, budget_name, 
            contract_number, master_contract_number, master_child_contract_number, 
            contract_vendor_id, contract_vendor_id_cy, master_contract_vendor_id, 
            master_contract_vendor_id_cy, contract_agency_id, contract_agency_id_cy, 
            master_contract_agency_id, master_contract_agency_id_cy, master_purpose, 
            master_purpose_cy, purpose, purpose_cy, master_child_contract_agency_id, 
            master_child_contract_agency_id_cy, master_child_contract_vendor_id, 
            master_child_contract_vendor_id_cy, reporting_code, location_id, 
            fund_class_name, fund_class_code, spending_category_id, spending_category_name, 
            calendar_fiscal_year_id, calendar_fiscal_year, agreement_accounting_line_number, 
            agreement_commodity_line_number, agreement_vendor_line_number, 
            reference_document_number, reference_document_code, contract_document_code, 
            master_contract_document_code, file_type, load_id, last_modified_date, 
            job_id
	FROM disbursement_line_item_details_mwbe;


	

	
	
	
CREATE OR REPLACE FUNCTION etl.updateFMSDataForMWBE(p_job_id_in bigint) RETURNS INT AS
$$
DECLARE
	l_start_time  timestamp;
	l_end_time  timestamp;
BEGIN
	-- Inserting into the disbursement_line_item_details
	
	l_start_time := timeofday()::timestamp;
	
	RAISE NOTICE 'FMS RF 1';
	
	UPDATE disbursement_line_item_details
	SET  minority_type_id = NULL;	
	
	UPDATE disbursement_line_item_details a
	SET minority_type_id = c.minority_type_id, 
		minority_type_name = c.minority_type_name
	FROM disbursement b , vendor_min_bus_type c
	WHERE a.disbursement_id = b.disbursement_id AND b.vendor_history_id = c.vendor_history_id
	AND a.spending_category_id <>2 and file_type <> 'P';
	
	UPDATE disbursement_line_item_details
	SET minority_type_id = 11, 
		minority_type_name = 'Individuals & Others'
	WHERE spending_category_id = 2;
	
	
	
	
		UPDATE disbursement_line_item_details a
	SET minority_type_id = (case when b.bustype_exmp = 'EXMP' AND b.bustype_exmp_status = 2 then 11
			when b.bustype_mnrt = 'MNRT' AND b.bustype_mnrt_status = 2 then c.minority_type_id 
			WHEN b.bustype_wmno = 'WMNO' AND b.bustype_wmno_status = 2 then 9
           		else NULL end),
		minority_type_name = (case when b.bustype_exmp = 'EXMP' AND b.bustype_exmp_status = 2 then 'Individuals & Others'
			when b.bustype_mnrt = 'MNRT' AND b.bustype_mnrt_status = 2 then c.minority_type_name 
			WHEN b.bustype_wmno = 'WMNO' AND b.bustype_wmno_status = 2 then 'Caucasian Woman'
           		else NULL end)
	FROM disbursement  b LEFT JOIN  ref_minority_type c on b.minority_type_id = c.minority_type_id
	WHERE a.disbursement_id = b.disbursement_id 
	AND a.spending_category_id <> 2 and file_type = 'P';
	
	
	
	RAISE NOTICE 'FMS RF 2';
	
	CREATE TEMPORARY TABLE tmp_agreement_con(disbursement_line_item_id bigint,agreement_id bigint,fiscal_year smallint,calendar_fiscal_year smallint,master_agreement_id bigint,  maximum_contract_amount numeric(16,2),
												maximum_contract_amount_cy numeric(16,2), maximum_spending_limit numeric(16,2), maximum_spending_limit_cy numeric(16,2),
												purpose varchar, purpose_cy varchar, contract_number varchar, master_contract_number varchar, contract_vendor_id integer, contract_vendor_id_cy integer,
												master_contract_vendor_id integer, master_contract_vendor_id_cy integer, contract_agency_id smallint, contract_agency_id_cy smallint, master_contract_agency_id smallint,
												master_contract_agency_id_cy smallint, master_purpose varchar, master_purpose_cy varchar, contract_document_code varchar, master_contract_document_code varchar, 
												industry_type_id smallint, industry_type_name varchar, agreement_type_code varchar, award_method_code varchar,
												contract_industry_type_id smallint, contract_industry_type_id_cy smallint, master_contract_industry_type_id smallint, master_contract_industry_type_id_cy smallint,
												contract_minority_type_id smallint, contract_minority_type_id_cy smallint, master_contract_minority_type_id smallint, master_contract_minority_type_id_cy smallint)
	DISTRIBUTED  BY (disbursement_line_item_id);
	
	INSERT INTO tmp_agreement_con(disbursement_line_item_id,agreement_id,fiscal_year,calendar_fiscal_year)
	SELECT DISTINCT a.disbursement_line_item_id, a.agreement_id, a.fiscal_year, a.calendar_fiscal_year 
	FROM disbursement_line_item_details a JOIN disbursement_line_item b ON a.disbursement_line_item_id = b.disbursement_line_item_id
		 JOIN disbursement c ON b.disbursement_id = c.disbursement_id
		WHERE  b.agreement_id > 0;
	
		
	-- Getting maximum_contract_amount, master_agreement_id, purpose, contract_number,  contract_vendor_id, contract_agency_id for FY from non master contracts.
	
	CREATE TEMPORARY TABLE tmp_agreement_con_fy(disbursement_line_item_id bigint,agreement_id bigint,master_agreement_id bigint, contract_number varchar,
						maximum_contract_amount_fy numeric(16,2), purpose_fy varchar, contract_vendor_id_fy integer, contract_agency_id_fy smallint, contract_document_code_fy varchar, 
						industry_type_id smallint, industry_type_name varchar, agreement_type_code varchar, award_method_code varchar,
						contract_industry_type_id_fy smallint, contract_minority_type_id_fy smallint)
	DISTRIBUTED  BY (disbursement_line_item_id);
	
	INSERT INTO tmp_agreement_con_fy
	SELECT a.disbursement_line_item_id, b.original_agreement_id,b.master_agreement_id,b.contract_number,
	b.maximum_contract_amount as maximum_contract_amount_fy ,
	b.description as purpose_fy ,
	b.vendor_id as contract_vendor_id_fy,
	b.agency_id as contract_agency_id_fy,
	e.document_code as contract_document_code_fy,
	b.industry_type_id as industry_type_id,
	b.industry_type_name as industry_type_name,
	b.agreement_type_code as agreement_type_code,
	b.award_method_code as award_method_code,
	b.industry_type_id as contract_industry_type_id_fy,
	b.minority_type_id as contract_minority_type_id_fy
		FROM tmp_agreement_con a JOIN agreement_snapshot b ON a.agreement_id = b.original_agreement_id AND a.fiscal_year between b.starting_year and b.ending_year
		JOIN disbursement_line_item c ON a.disbursement_line_item_id = c.disbursement_line_item_id
		JOIN disbursement d ON c.disbursement_id = d.disbursement_id 
		JOIN ref_document_code e ON b.document_code_id = e.document_code_id ;
		
	
	INSERT INTO tmp_agreement_con_fy
    SELECT a.disbursement_line_item_id, b.original_agreement_id,b.master_agreement_id,b.contract_number,
	b.maximum_contract_amount as maximum_contract_amount_fy ,
	b.description as purpose_fy ,
	b.vendor_id as contract_vendor_id_fy,
	b.agency_id as contract_agency_id_fy,
	e.document_code as contract_document_code_fy,
	b.industry_type_id as industry_type_id,
	b.industry_type_name as industry_type_name,
	b.agreement_type_code as agreement_type_code,
	b.award_method_code as award_method_code,
	b.industry_type_id as contract_industry_type_id_fy,
	b.minority_type_id as contract_minority_type_id_fy
		FROM tmp_agreement_con a JOIN agreement_snapshot b ON a.agreement_id = b.original_agreement_id AND b.latest_flag='Y'
		JOIN disbursement_line_item c ON a.disbursement_line_item_id = c.disbursement_line_item_id
		JOIN disbursement d ON c.disbursement_id = d.disbursement_id
		JOIN ref_document_code e ON b.document_code_id = e.document_code_id 
		LEFT JOIN tmp_agreement_con_fy f ON a.disbursement_line_item_id = f.disbursement_line_item_id
		WHERE f.disbursement_line_item_id IS NULL ;
   	
	UPDATE tmp_agreement_con a
	SET master_agreement_id = b.master_agreement_id,
		maximum_contract_amount = b.maximum_contract_amount_fy,
		purpose = b.purpose_fy,
		contract_number = b.contract_number,
		contract_vendor_id = b.contract_vendor_id_fy,
		contract_agency_id = b.contract_agency_id_fy,
		contract_document_code = b.contract_document_code_fy,
		industry_type_id = b.industry_type_id,
		industry_type_name = b.industry_type_name,
		agreement_type_code = b.agreement_type_code,
		award_method_code = b.award_method_code,
		contract_industry_type_id = b.contract_industry_type_id_fy,
		contract_minority_type_id = b.contract_minority_type_id_fy
	FROM tmp_agreement_con_fy b
	WHERE a.disbursement_line_item_id = b.disbursement_line_item_id;
	
	RAISE NOTICE 'FMS RF 3.0';
	
	-- Getting maximum_spending_limit, master_contract_number, master_contract_vendor_id, master_contract_agency_id for FY for master agreements
	
	CREATE TEMPORARY TABLE tmp_agreement_con_master_fy(disbursement_line_item_id bigint, master_agreement_id bigint, master_contract_number varchar, maximum_spending_limit_fy numeric(16,2), 
	master_contract_vendor_id_fy integer, master_contract_agency_id_fy smallint, master_purpose_fy varchar, master_contract_document_code_fy varchar, 
	master_contract_industry_type_id_fy smallint, master_contract_minority_type_id_fy smallint)
	DISTRIBUTED  BY (disbursement_line_item_id);
	
	INSERT INTO tmp_agreement_con_master_fy
	SELECT a.disbursement_line_item_id, a.master_agreement_id,
	b.contract_number as master_contract_number,
	b.maximum_contract_amount as maximum_spending_limit_fy ,
	b.vendor_id as master_contract_vendor_id_fy,
	b.agency_id as master_contract_agency_id_fy,
	b.description as master_purpose_fy,
	e.document_code as master_contract_document_code_fy,
	b.industry_type_id as master_contract_industry_type_id_fy,
	b.minority_type_id as master_contract_minority_type_id_fy
	FROM tmp_agreement_con a JOIN agreement_snapshot b ON a.master_agreement_id = b.original_agreement_id AND b.master_agreement_yn = 'Y' AND a.fiscal_year between b.starting_year and b.ending_year
		JOIN disbursement_line_item c ON a.disbursement_line_item_id = c.disbursement_line_item_id
		JOIN disbursement d ON c.disbursement_id = d.disbursement_id 
		JOIN ref_document_code e ON b.document_code_id = e.document_code_id;
		
	INSERT INTO tmp_agreement_con_master_fy
	SELECT a.disbursement_line_item_id, a.master_agreement_id,
	b.contract_number as master_contract_number,
	b.maximum_contract_amount as maximum_spending_limit_fy ,
	b.vendor_id as master_contract_vendor_id_fy,
	b.agency_id as master_contract_agency_id_fy,
	b.description as master_purpose_fy ,
	e.document_code as master_contract_document_code_fy,
	b.industry_type_id as master_contract_industry_type_id_fy,
	b.minority_type_id as master_contract_minority_type_id_fy
	FROM tmp_agreement_con a JOIN agreement_snapshot b ON a.master_agreement_id = b.original_agreement_id AND b.master_agreement_yn = 'Y' AND b.latest_flag='Y'
		JOIN disbursement_line_item c ON a.disbursement_line_item_id = c.disbursement_line_item_id
		JOIN disbursement d ON c.disbursement_id = d.disbursement_id 
		JOIN ref_document_code e ON b.document_code_id = e.document_code_id
		LEFT JOIN tmp_agreement_con_master_fy f ON a.disbursement_line_item_id = f.disbursement_line_item_id
		WHERE f.disbursement_line_item_id IS NULL ;
		
		
	
	UPDATE tmp_agreement_con a
	SET maximum_spending_limit = b.maximum_spending_limit_fy,
		master_contract_number = b.master_contract_number,
		master_contract_vendor_id = b.master_contract_vendor_id_fy,
		master_contract_agency_id = b.master_contract_agency_id_fy,
		master_purpose = b.master_purpose_fy,
		master_contract_document_code = b.master_contract_document_code_fy,
		master_contract_industry_type_id = b.master_contract_industry_type_id_fy,
		master_contract_minority_type_id = b.master_contract_minority_type_id_fy
	FROM tmp_agreement_con_master_fy b
	WHERE a.disbursement_line_item_id = b.disbursement_line_item_id;
	
	
	
	RAISE NOTICE 'FMS RF 3';
	

	
	-- Getting maximum_contract_amount, master_agreement_id, purpose, contract_number,  contract_vendor_id, contract_agency_id for CY from non master contracts.
	
	CREATE TEMPORARY TABLE tmp_agreement_con_cy(disbursement_line_item_id bigint,agreement_id bigint,
						maximum_contract_amount_cy numeric(16,2), purpose_cy varchar, contract_vendor_id_cy integer, contract_agency_id_cy smallint, 
						contract_industry_type_id_cy smallint, contract_minority_type_id_cy smallint)
	DISTRIBUTED  BY (disbursement_line_item_id);
	
	INSERT INTO tmp_agreement_con_cy
    SELECT a.disbursement_line_item_id, b.original_agreement_id,
	b.maximum_contract_amount as maximum_contract_amount_cy ,
	b.description as purpose_cy ,
	b.vendor_id as contract_vendor_id_cy,
	b.agency_id as contract_agency_id_cy,
	b.industry_type_id as contract_industry_type_id_cy,
	b.minority_type_id as contract_minority_type_id_cy
		FROM tmp_agreement_con a JOIN agreement_snapshot_cy b ON a.agreement_id = b.original_agreement_id AND a.calendar_fiscal_year between b.starting_year and b.ending_year
		JOIN disbursement_line_item c ON a.disbursement_line_item_id = c.disbursement_line_item_id
		JOIN ref_document_code e ON b.document_code_id = e.document_code_id;
		
	
	INSERT INTO tmp_agreement_con_cy
    SELECT a.disbursement_line_item_id, b.original_agreement_id,
	b.maximum_contract_amount as maximum_contract_amount_cy ,
	b.description as purpose_cy ,
	b.vendor_id as contract_vendor_id_cy,
	b.agency_id as contract_agency_id_cy,
	b.industry_type_id as contract_industry_type_id_cy,
	b.minority_type_id as contract_minority_type_id_cy
		FROM tmp_agreement_con a JOIN agreement_snapshot_cy b ON a.agreement_id = b.original_agreement_id AND b.latest_flag='Y'
		JOIN disbursement_line_item c ON a.disbursement_line_item_id = c.disbursement_line_item_id
		JOIN disbursement d ON c.disbursement_id = d.disbursement_id
		LEFT JOIN tmp_agreement_con_cy f ON a.disbursement_line_item_id = f.disbursement_line_item_id
		WHERE f.disbursement_line_item_id IS NULL ;
   
		
	UPDATE tmp_agreement_con a
	SET maximum_contract_amount_cy = b.maximum_contract_amount_cy,
		purpose_cy = b.purpose_cy,
		contract_vendor_id_cy = b.contract_vendor_id_cy,
		contract_agency_id_cy = b.contract_agency_id_cy,
		contract_industry_type_id_cy = b.contract_industry_type_id_cy,
		contract_minority_type_id_cy = b.contract_minority_type_id_cy
	FROM tmp_agreement_con_cy b
	WHERE a.disbursement_line_item_id = b.disbursement_line_item_id;
	
	RAISE NOTICE 'FMS RF 3.1';
	
	-- Getting maximum_spending_limit, master_contract_number, master_contract_vendor_id, master_contract_agency_id for FY for master agreements
	
	CREATE TEMPORARY TABLE tmp_agreement_con_master_cy(disbursement_line_item_id bigint, master_agreement_id bigint,  maximum_spending_limit_cy numeric(16,2), 
	master_contract_vendor_id_cy integer, master_contract_agency_id_cy smallint, master_purpose_cy varchar, 
	master_contract_industry_type_id_cy smallint, master_contract_minority_type_id_cy smallint)
	DISTRIBUTED  BY (disbursement_line_item_id);
	
	
	INSERT INTO tmp_agreement_con_master_cy
	SELECT a.disbursement_line_item_id, a.master_agreement_id,
	b.maximum_contract_amount as maximum_spending_limit_cy ,
	b.vendor_id as master_contract_vendor_id_cy,
	b.agency_id as master_contract_agency_id_cy,
	b.description as master_purpose_cy,
	b.industry_type_id as master_contract_industry_type_id_cy,
	b.minority_type_id as master_contract_minority_type_id_cy
	FROM tmp_agreement_con a JOIN agreement_snapshot_cy b ON a.master_agreement_id = b.original_agreement_id AND b.master_agreement_yn = 'Y' AND a.calendar_fiscal_year between b.starting_year and b.ending_year
		JOIN disbursement_line_item c ON a.disbursement_line_item_id = c.disbursement_line_item_id
		JOIN ref_document_code e ON b.document_code_id = e.document_code_id;
		
		
	INSERT INTO tmp_agreement_con_master_cy
	SELECT a.disbursement_line_item_id, a.master_agreement_id,
	b.maximum_contract_amount as maximum_spending_limit_cy ,
	b.vendor_id as master_contract_vendor_id_cy,
	b.agency_id as master_contract_agency_id_cy,
	b.description as master_purpose_cy,
	b.industry_type_id as master_contract_industry_type_id_cy,
	b.minority_type_id as master_contract_minority_type_id_cy
	FROM tmp_agreement_con a JOIN agreement_snapshot_cy b ON a.master_agreement_id = b.original_agreement_id AND b.master_agreement_yn = 'Y' AND b.latest_flag='Y'
		JOIN disbursement_line_item c ON a.disbursement_line_item_id = c.disbursement_line_item_id
		JOIN disbursement d ON c.disbursement_id = d.disbursement_id 
		LEFT JOIN tmp_agreement_con_master_cy f ON a.disbursement_line_item_id = f.disbursement_line_item_id
		WHERE f.disbursement_line_item_id IS NULL ;
		
		

		
	UPDATE tmp_agreement_con a
	SET maximum_spending_limit_cy = b.maximum_spending_limit_cy,
		master_contract_vendor_id_cy = b.master_contract_vendor_id_cy,
		master_contract_agency_id_cy = b.master_contract_agency_id_cy,
		master_purpose_cy = b.master_purpose_cy,
		master_contract_industry_type_id_cy = b.master_contract_industry_type_id_cy,
		master_contract_minority_type_id_cy = b.master_contract_minority_type_id_cy
	FROM tmp_agreement_con_master_cy b
	WHERE a.disbursement_line_item_id = b.disbursement_line_item_id;
	
	RAISE NOTICE 'FMS RF 4';
	
	UPDATE disbursement_line_item_details a
	SET	industry_type_id = b.industry_type_id,
		industry_type_name = b.industry_type_name,
		agreement_type_code = b.agreement_type_code,
		award_method_code = b.award_method_code,
		contract_industry_type_id = b.contract_industry_type_id,
		contract_industry_type_id_cy = b.contract_industry_type_id_cy,
		master_contract_industry_type_id = b.master_contract_industry_type_id,
		master_contract_industry_type_id_cy = b.master_contract_industry_type_id_cy,
		contract_minority_type_id = b.contract_minority_type_id,
		contract_minority_type_id_cy = b.contract_minority_type_id_cy,
		master_contract_minority_type_id = b.master_contract_minority_type_id,
		master_contract_minority_type_id_cy = b.master_contract_minority_type_id_cy,
		purpose = b.purpose,
		master_purpose = b.master_purpose,
		purpose_cy = b.purpose_cy,
		master_purpose_cy = b.master_purpose_cy,
		maximum_contract_amount =b.maximum_contract_amount,
		maximum_spending_limit = b.maximum_spending_limit,
		maximum_contract_amount_cy =b.maximum_contract_amount_cy,
		maximum_spending_limit_cy = b.maximum_spending_limit_cy
	FROM	tmp_agreement_con  b
	WHERE   a.disbursement_line_item_id = b.disbursement_line_item_id;
	
	RAISE NOTICE 'FMS RF 5';
	
UPDATE disbursement_line_item_details
SET minority_type_id=11,
minority_type_name = 'Individuals & Others'
WHERE  agreement_type_code IN ('35','36','39','40','44','65','68','79','85') 
AND ( minority_type_id IS NULL OR minority_type_id IN (1,6,7,8));

UPDATE disbursement_line_item_details
SET minority_type_id=11,
minority_type_name = 'Individuals & Others'
WHERE  award_method_code IN ('07','08','09','17','18','44','45','55')
AND ( minority_type_id IS NULL OR minority_type_id IN (1,6,7,8));

UPDATE disbursement_line_item_details a
SET minority_type_id=11,
minority_type_name = 'Individuals & Others'
FROM disbursement b 
WHERE a.disbursement_id = b.disbursement_id 
AND b.vendor_org_classification IN (1,5,6,7,8,9,12,13,14,15,19,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36) 
AND ( a.minority_type_id IS NULL OR a.minority_type_id IN (1,6,7,8));

UPDATE disbursement_line_item_details
SET minority_type_id=7,
	minority_type_name = 'Non-Minority'
WHERE  ( minority_type_id IS NULL OR minority_type_id IN (1,6,7,8));

	RAISE NOTICE 'FMS RF 6';
	
	l_end_time := timeofday()::timestamp;
	
	INSERT INTO etl.etl_script_execution_status(job_id,script_name,completed_flag,start_time,end_time)
	VALUES(p_job_id_in,'etl.updateFMSDataForMWBE',1,l_start_time,l_end_time);
	
	RETURN 1;
	
EXCEPTION
	WHEN OTHERS THEN
	RAISE NOTICE 'Exception Occurred in updateFMSDataForMWBE';
	RAISE NOTICE 'SQL ERRROR % and Desc is %' ,SQLSTATE,SQLERRM;	
	
	l_end_time := timeofday()::timestamp;
	
	INSERT INTO etl.etl_script_execution_status(job_id,script_name,completed_flag,start_time,end_time,errno,errmsg)
	VALUES(p_job_id_in,'etl.updateFMSDataForMWBE',0,l_start_time,l_end_time,SQLSTATE,SQLERRM);
	
	RETURN 0;
	
END;
$$ language plpgsql;	


select etl.updateFMSDataForMWBE(max_job_id);


DROP TABLE IF EXISTS disbursement_line_item_details_mwbe;




DROP TABLE IF EXISTS pending_contracts_mwbe;
 DROP TABLE IF EXISTS pending_contracts_backup;
 
 CREATE TABLE pending_contracts_mwbe as select * from pending_contracts ;
 
 CREATE TABLE pending_contracts_backup as select * from pending_contracts ;
 
 DROP TABLE IF EXISTS pending_contracts CASCADE;

CREATE TABLE pending_contracts(
 	document_code_id smallint,
 	document_agency_id  smallint,
 	document_id  varchar,
  	parent_document_code_id smallint,
  	parent_document_agency_id  smallint,
 	parent_document_id  varchar,
 	encumbrance_amount_original numeric(15,2),
 	encumbrance_amount numeric(15,2),
 	original_maximum_amount_original numeric(15,2),
 	original_maximum_amount numeric(15,2),
 	revised_maximum_amount_original numeric(15,2),
 	revised_maximum_amount numeric(15,2),
 	registered_contract_max_amount numeric(15,2),
 	vendor_legal_name varchar(80),
 	vendor_customer_code varchar(20),
 	vendor_id int,
 	description varchar(78),
 	submitting_agency_id  smallint,
 	oaisis_submitting_agency_desc	 varchar(50),
 	submitting_agency_code	 varchar(4),
 	awarding_agency_id  smallint,
 	oaisis_awarding_agency_desc	 varchar(50),
 	awarding_agency_code	 varchar(4),
 	contract_type_name varchar(40),
 	cont_type_code  varchar(2),
 	award_method_name varchar(50),
 	award_method_code varchar(3),
 	award_method_id smallint,
 	start_date date,
 	end_date date,
 	revised_start_date date,
 	revised_end_date date,
 	cif_received_date date,
 	cif_fiscal_year smallint,
 	cif_fiscal_year_id smallint,
 	tracking_number varchar(30),
 	board_award_number varchar(15),
 	oca_number varchar(10),
	version_number varchar(5),
	fms_contract_number varchar,
	contract_number varchar,
	fms_parent_contract_number varchar,
	submitting_agency_name varchar,
	submitting_agency_short_name varchar,
	awarding_agency_name varchar,
	awarding_agency_short_name varchar,
	start_date_id int,
	end_date_id int,	
	revised_start_date_id int,
	revised_end_date_id int,	
	cif_received_date_id int,
	document_agency_code varchar, 
	document_agency_name varchar, 
	document_agency_short_name varchar ,
	funding_agency_id  smallint,
	funding_agency_code varchar, 
	funding_agency_name varchar, 
	funding_agency_short_name varchar ,
	original_agreement_id bigint,
	original_master_agreement_id bigint,
	dollar_difference numeric(16,2),
  	percent_difference numeric(17,4),
	original_or_modified varchar,
	original_or_modified_desc varchar,
	award_size_id smallint,
	award_category_id smallint,
	industry_type_id smallint,
	document_version smallint,
	minority_type_id smallint,
 	minority_type_name character varying(50),
	latest_flag char(1)
 ) DISTRIBUTED BY (document_code_id);


INSERT INTO pending_contracts(
            document_code_id, document_agency_id, document_id, parent_document_code_id, 
            parent_document_agency_id, parent_document_id, encumbrance_amount_original, 
            encumbrance_amount, original_maximum_amount_original, original_maximum_amount, 
            revised_maximum_amount_original, revised_maximum_amount, registered_contract_max_amount, 
            vendor_legal_name, vendor_customer_code, vendor_id, description, 
            submitting_agency_id, oaisis_submitting_agency_desc, submitting_agency_code, 
            awarding_agency_id, oaisis_awarding_agency_desc, awarding_agency_code, 
            contract_type_name, cont_type_code, award_method_name, award_method_code, 
            award_method_id, start_date, end_date, revised_start_date, revised_end_date, 
            cif_received_date, cif_fiscal_year, cif_fiscal_year_id, tracking_number, 
            board_award_number, oca_number, version_number, fms_contract_number, 
            contract_number, fms_parent_contract_number, submitting_agency_name, 
            submitting_agency_short_name, awarding_agency_name, awarding_agency_short_name, 
            start_date_id, end_date_id, revised_start_date_id, revised_end_date_id, 
            cif_received_date_id, document_agency_code, document_agency_name, 
            document_agency_short_name, funding_agency_id, funding_agency_code, 
            funding_agency_name, funding_agency_short_name, original_agreement_id, 
            original_master_agreement_id, dollar_difference, percent_difference, 
            original_or_modified, original_or_modified_desc, award_size_id, 
            award_category_id, industry_type_id, document_version, minority_type_id, minority_type_name, latest_flag)
    SELECT document_code_id, document_agency_id, document_id, parent_document_code_id, 
            parent_document_agency_id, parent_document_id, encumbrance_amount_original, 
            encumbrance_amount, original_maximum_amount_original, original_maximum_amount, 
            revised_maximum_amount_original, revised_maximum_amount, registered_contract_max_amount, 
            vendor_legal_name, vendor_customer_code, vendor_id, description, 
            submitting_agency_id, oaisis_submitting_agency_desc, submitting_agency_code, 
            awarding_agency_id, oaisis_awarding_agency_desc, awarding_agency_code, 
            contract_type_name, cont_type_code, award_method_name, award_method_code, 
            award_method_id, start_date, end_date, revised_start_date, revised_end_date, 
            cif_received_date, cif_fiscal_year, cif_fiscal_year_id, tracking_number, 
            board_award_number, oca_number, version_number, fms_contract_number, 
            contract_number, fms_parent_contract_number, submitting_agency_name, 
            submitting_agency_short_name, awarding_agency_name, awarding_agency_short_name, 
            start_date_id, end_date_id, revised_start_date_id, revised_end_date_id, 
            cif_received_date_id, document_agency_code, document_agency_name, 
            document_agency_short_name, funding_agency_id, funding_agency_code, 
            funding_agency_name, funding_agency_short_name, original_agreement_id, 
            original_master_agreement_id, dollar_difference, percent_difference, 
            original_or_modified, original_or_modified_desc, award_size_id, 
            award_category_id, industry_type_id, document_version, NULL as minority_type_id, NULL as minority_type_name, latest_flag
    FROM pending_contracts_mwbe;


DROP TABLE IF EXISTS pending_contracts_mwbe;



	UPDATE pending_contracts c
	SET minority_type_id = (case when a.business_type_id = 2 then 11 
	   							 when a.business_type_id = 5 then 9
           						 else a.minority_type_id end),
	    minority_type_name = (case  when a.business_type_id = 2 then 'Individuals & Others' 
	   								when a.business_type_id = 5 then 'Caucasian Woman'
           							else b.minority_type_name end)
	FROM (select vendor_customer_code , business_type_id, minority_type_id from fmsv_business_type 
				where status =2 and (business_type_id=2 or minority_type_id is not null or (vendor_customer_code in 
					(select distinct vendor_customer_code from fmsv_business_type 
					  where  business_type_id = 5 and status = 2 
					and vendor_customer_code not in (select distinct vendor_customer_code from fmsv_business_type where minority_type_id is not null and status = 2))
					AND business_type_id=5))) a JOIN ref_minority_type b ON a.minority_type_id = b.minority_type_id
	WHERE a.vendor_customer_code = c.vendor_customer_code;
	
	
	UPDATE pending_contracts a
	SET minority_type_id=11,
		minority_type_name = 'Individuals & Others'
	WHERE  (case when length(a.award_method_code)= 1 THEN lpad(a.award_method_code,2,'0') ELSE a.award_method_code END) IN ('07','08','09','17','18','44','45','55') 
	AND ( minority_type_id IS NULL OR minority_type_id IN (1,6,7,8));
	
	UPDATE pending_contracts a
	SET minority_type_id=7,
		minority_type_name = 'Non-Minority'
	WHERE ( minority_type_id IS NULL OR minority_type_id IN (1,6,7,8));

	
	
-- aggregate tables Scripts

DROP TABLE IF EXISTS aggregateon_mwbe_spending_coa_entities;
CREATE TABLE aggregateon_mwbe_spending_coa_entities (
	department_id integer,
	agency_id smallint,
	spending_category_id smallint,
	expenditure_object_id integer,
	vendor_id integer,
	minority_type_id smallint,
	industry_type_id smallint,
	month_id int,
	year_id smallint,
	type_of_year char(1),
	total_spending_amount numeric(16,2),
	total_disbursements integer
	) DISTRIBUTED BY (department_id) ;

DROP TABLE IF EXISTS aggregateon_mwbe_spending_contract;
CREATE TABLE aggregateon_mwbe_spending_contract (
    agreement_id bigint,
    document_id character varying(20),
    document_code character varying(8),
	vendor_id integer,
	minority_type_id smallint,
	industry_type_id smallint,
	agency_id smallint,
	description character varying(60),
	spending_category_id smallint,
	year_id smallint,
	type_of_year char(1),
	total_spending_amount numeric(16,2), 
	total_contract_amount numeric(16,2)
	) DISTRIBUTED BY (agreement_id) ;

	
DROP TABLE IF EXISTS aggregateon_mwbe_spending_vendor;
CREATE TABLE aggregateon_mwbe_spending_vendor (
	vendor_id integer,
	minority_type_id smallint,
	industry_type_id smallint,
	agency_id smallint,
	spending_category_id smallint,
	year_id smallint,
	type_of_year char(1),
	total_spending_amount numeric(16,2), 
	total_contract_amount numeric(16,2),
	is_all_categories char(1)
	) DISTRIBUTED BY (vendor_id) ;


DROP TABLE IF EXISTS aggregateon_mwbe_spending_vendor_exp_object;
CREATE TABLE aggregateon_mwbe_spending_vendor_exp_object(
	vendor_id integer,
	minority_type_id smallint,
	industry_type_id smallint,
	expenditure_object_id integer,
	spending_category_id smallint,
	year_id smallint,
	type_of_year char(1),
	total_spending_amount numeric(16,2) )
DISTRIBUTED BY (expenditure_object_id);	


DROP TABLE IF EXISTS aggregateon_mwbe_contracts_cumulative_spending;
CREATE TABLE aggregateon_mwbe_contracts_cumulative_spending(
	original_agreement_id bigint,
	fiscal_year smallint,
	fiscal_year_id smallint,
	document_code_id smallint,
	master_agreement_yn character(1),
	description varchar,
	contract_number varchar,
	vendor_id int,
	minority_type_id smallint,
	award_method_id smallint,
	agency_id smallint,
	industry_type_id smallint,
    award_size_id smallint,
	original_contract_amount numeric(16,2),
	maximum_contract_amount numeric(16,2),
	spending_amount_disb numeric(16,2),
	spending_amount numeric(16,2),
	current_year_spending_amount numeric(16,2),
	dollar_difference numeric(16,2),
	percent_difference numeric(16,2),
	status_flag char(1),
	type_of_year char(1)	
) DISTRIBUTED BY (vendor_id);	


DROP TABLE IF EXISTS aggregateon_mwbe_contracts_spending_by_month;
CREATE TABLE aggregateon_mwbe_contracts_spending_by_month(
	original_agreement_id bigint,
	fiscal_year smallint,
	fiscal_year_id smallint,
	document_code_id smallint,
	month_id integer,
	vendor_id int,
	minority_type_id smallint,
	award_method_id smallint,
	agency_id smallint,
	industry_type_id smallint,
    award_size_id smallint,
	spending_amount numeric(16,2),
	status_flag char(1),
	type_of_year char(1)	
) DISTRIBUTED BY (vendor_id);	


DROP TABLE IF EXISTS aggregateon_mwbe_total_contracts;
CREATE TABLE aggregateon_mwbe_total_contracts(
	fiscal_year smallint,
	fiscal_year_id smallint,
	vendor_id int,
	minority_type_id smallint,
	award_method_id smallint,
	agency_id smallint,
	industry_type_id smallint,
    award_size_id smallint,
	total_contracts bigint,
	total_commited_contracts bigint,
	total_master_agreements bigint,
	total_standalone_contracts bigint,
	total_revenue_contracts bigint,
	total_revenue_contracts_amount numeric(16,2),
	total_commited_contracts_amount numeric(16,2),
	total_contracts_amount numeric(16,2),
	total_spending_amount_disb numeric(16,2),
	total_spending_amount numeric(16,2),
	status_flag char(1),
	type_of_year char(1)
) DISTRIBUTED BY (fiscal_year);	


DROP TABLE IF EXISTS aggregateon_mwbe_contracts_department;
CREATE TABLE aggregateon_mwbe_contracts_department(
	document_code_id smallint,
	document_agency_id smallint,
	agency_id smallint,
	department_id integer,
	fiscal_year smallint,
	fiscal_year_id smallint,
	award_method_id smallint,
	vendor_id int,
	minority_type_id smallint,
	industry_type_id smallint,
    award_size_id smallint,
	spending_amount_disb numeric(16,2),
	spending_amount numeric(16,2),
	total_contracts integer,
	status_flag char(1),
	type_of_year char(1)
) DISTRIBUTED BY (department_id);	


DROP TABLE IF EXISTS contracts_mwbe_spending_transactions;
CREATE TABLE contracts_mwbe_spending_transactions(
	disbursement_line_item_id bigint,
	original_agreement_id bigint,
	fiscal_year smallint,
	fiscal_year_id smallint,
	document_code_id smallint,
	vendor_id int,
	minority_type_id smallint,
	award_method_id smallint,
	document_agency_id smallint,
	industry_type_id smallint,
    award_size_id smallint,
	disb_document_id  character varying(20),
	disb_vendor_name  character varying,
	disb_check_eft_issued_date  date,
	disb_agency_name  character varying(100),
	disb_department_short_name  character varying(15),
	disb_check_amount  numeric(16,2),
	disb_expenditure_object_name  character varying(40),
	disb_budget_name  character varying(60),
	disb_contract_number  character varying,
	disb_purpose  character varying,
	disb_reporting_code  character varying(15),
	disb_spending_category_name  character varying,
	disb_agency_id  smallint,
	disb_vendor_id  integer,
	disb_expenditure_object_id  integer,
	disb_department_id  integer,
	disb_spending_category_id  smallint,
	disb_agreement_id  bigint,
	disb_contract_document_code  character varying(8),
	disb_master_agreement_id  bigint,
	disb_fiscal_year_id  smallint,
	disb_check_eft_issued_cal_month_id integer,
	disb_disbursement_number character varying(40),
	status_flag char(1),
	type_of_year char(1)
) DISTRIBUTED BY (disbursement_line_item_id);	


DROP TABLE IF EXISTS contract_vendor_latest_mwbe_category;
CREATE TABLE contract_vendor_latest_mwbe_category (
	vendor_id integer,
	vendor_history_id integer,
	agency_id smallint,
	minority_type_id smallint,
	year_id smallint,
	type_of_year char(1)
	) DISTRIBUTED BY (vendor_id) ;
	

DROP TABLE IF EXISTS spending_vendor_latest_mwbe_category;
CREATE TABLE spending_vendor_latest_mwbe_category (
	vendor_id integer,
	vendor_history_id integer,
	agency_id smallint,
	minority_type_id smallint,
	year_id smallint,
	type_of_year char(1)
	) DISTRIBUTED BY (vendor_id) ;
	
	
select etl.refreshaggregates(max_job_id);

select etl.grantaccess('webuser1','SELECT');

-- Testing queries

select count(*) from aggregateon_mwbe_contracts_department;

 select count(*) from aggregateon_contracts_department;
 
 select document_code_id, document_agency_id, agency_id, department_id, fiscal_year, award_method_id, vendor_id, industry_type_id, award_size_id, status_flag, type_of_year, count(distinct minority_type_id) from aggregateon_mwbe_contracts_department group by document_code_id, document_agency_id, agency_id, department_id, fiscal_year, award_method_id, vendor_id, industry_type_id, award_size_id, status_flag, type_of_year having count(distinct minority_type_id) > 1;
 
 select * from vendor_min_bus_type where vendor_history_id in (select vendor_history_id from vendor_history where vendor_id = 13970);
 
 select * from aggregateon_mwbe_contracts_department where document_code_id = 10 AND document_agency_id = 138 AND agency_id=138 AND department_id =383736 AND fiscal_year=2013 AND award_method_id=35 AND vendor_id=13970 AND industry_type_id=2 AND award_size_id=4 AND status_flag = 'A' AND type_of_year = 'C';
 
 select distinct vendor_history_id from agreement_snapshot_cy where vendor_id = 13970 and agency_id = 138 AND starting_year_id <=114 and ending_year_id >=114 limit 10;
 
 select * from vendor_min_bus_type where vendor_history_id in (select distinct vendor_history_id from agreement_snapshot_cy where vendor_id = 13970 and agency_id = 138 AND starting_year_id <=114 and ending_year_id >=114) order by vendor_history_id;
 
 select distinct a.vendor_id from disbursement_line_item_details a JOIN vendor b ON a.vendor_id = b.vendor_id where file_type = 'P' and b.vendor_customer_code <> 'N/A'

select * from vendor where vendor_id = 85910

select a.* from vendor_business_type a JOIN vendor_history b ON a.vendor_history_id = b.vendor_history_id JOIN vendor c ON b.vendor_id = c.vendor_id WHERE c.vendor_customer_code = 'N/A'

select minority_type_id, count(*) from disbursement_line_item_details where file_type = 'P' group by 1

select minority_type_id, count(*) from disbursement_line_item_details  group by 1


select count(*) from disbursement_line_item_details where minority_type_id IS NULL and job_id = 559

select count(*), minority_type_id from disbursement_line_item_details where job_id = 559 group by 2

select * from etl.etl_script_execution_status  where job_id = 559


select agreement_id, fiscal_year, count(distinct maximum_contract_amount) from disbursement_line_item_details group by 1,2 having count(distinct maximum_contract_amount) > 1


select count(distinct industry_type_id), agreement_id, year_id, type_of_year from aggregateon_mwbe_spending_contract group by 2,3,4 having count(distinct industry_type_id) > 1

select count(distinct minority_type_id), agreement_id, year_id, type_of_year from aggregateon_mwbe_spending_contract group by 2,3,4 having count(distinct minority_type_id) > 1
 