select count(*), document_code_id from agreement_snapshot_expanded where fiscal_year = 2011 and status_flag = 'R' and master_agreement_yn = 'Y' group by 2

select count(*) from aggregateon_contracts_cumulative_spending where type_of_year = 'B'

-- testing the existence of key fields. And if value is not there verifying if it is the correct case or not

select 
count(*) as total_records, 
SUM(CASE WHEN coalesce(description, '') <> '' THEN 1 ELSE 0 END) as count_with_purpose,
SUM(CASE WHEN coalesce(description, '') = '' THEN 1 ELSE 0 END) as count_with_no_purpose,
SUM(CASE WHEN coalesce(contract_number, '') <> '' THEN 1 ELSE 0 END) as count_with_contract_number,
SUM(CASE WHEN coalesce(contract_number, '') = '' THEN 1 ELSE 0 END) as count_with_no_contract_number,
SUM(CASE WHEN coalesce(agency_id, 0) <> 0 THEN 1 ELSE 0 END) as count_with_agency_id,
SUM(CASE WHEN coalesce(agency_id, 0) = 0 THEN 1 ELSE 0 END) as count_with_no_agency_id,
SUM(CASE WHEN coalesce(vendor_id, 0) <> 0 THEN 1 ELSE 0 END) as count_with_vendor_id,
SUM(CASE WHEN coalesce(vendor_id, 0) = 0 THEN 1 ELSE 0 END) as count_with_no_vendor_id,
SUM(CASE WHEN original_contract_amount IS NOT NULL THEN 1 ELSE 0 END) as count_with_original_contract_amount,
SUM(CASE WHEN original_contract_amount IS NULL THEN 1 ELSE 0 END) as count_with_no_original_contract_amount,
SUM(CASE WHEN maximum_contract_amount IS NOT NULL THEN 1 ELSE 0 END) as count_with_maximum_contract_amount,
SUM(CASE WHEN maximum_contract_amount IS NULL THEN 1 ELSE 0 END) as count_with_no_maximum_contract_amount,
SUM(CASE WHEN spending_amount IS NOT NULL THEN 1 ELSE 0 END) as count_with_spending_amount,
SUM(CASE WHEN spending_amount IS NULL THEN 1 ELSE 0 END) as count_with_no_spending_amount,
SUM(CASE WHEN dollar_difference IS NOT NULL THEN 1 ELSE 0 END) as count_with_dollar_difference,
SUM(CASE WHEN dollar_difference IS NULL THEN 1 ELSE 0 END) as count_with_no_dollar_difference,
SUM(CASE WHEN percent_difference IS NOT NULL THEN 1 ELSE 0 END) as count_with_percent_difference,
SUM(CASE WHEN percent_difference IS NULL THEN 1 ELSE 0 END) as count_with_no_percent_difference,
SUM(CASE WHEN coalesce(award_method_id, 0) <> 0 THEN 1 ELSE 0 END) as count_with_award_method_id,
SUM(CASE WHEN coalesce(award_method_id, 0) = 0 THEN 1 ELSE 0 END) as count_with_no_award_method_id,
SUM(CASE WHEN coalesce(fiscal_year, 0) <> 0 THEN 1 ELSE 0 END) as count_with_fiscal_year,
SUM(CASE WHEN coalesce(fiscal_year, 0) = 0 THEN 1 ELSE 0 END) as count_with_no_fiscal_year,
SUM(CASE WHEN coalesce(master_agreement_yn, '') <> '' THEN 1 ELSE 0 END) as count_with_master_agreement_yn,
SUM(CASE WHEN coalesce(master_agreement_yn, '') = '' THEN 1 ELSE 0 END) as count_with_no_master_agreement_yn
 from aggregateon_contracts_cumulative_spending where type_of_year = 'B' and master_agreement_yn = 'N';


SELECT * FROM aggregateon_contracts_cumulative_spending where type_of_year = 'B' AND maximum_contract_amount IS NULL ;

SELECT * from disbursement_line_item_details where agreement_id in (select original_agreement_id from aggregateon_contracts_cumulative_spending where type_of_year = 'B' AND maximum_contract_amount IS NULL AND agency_id IS NULL);

select * from agreement_snapshot where agreement_id = 411214 and 2010 between starting_year and ending_year

select * from history_agreement where agreement_id = 411214

select * from agreement_snapshot a,
(select original_agreement_id, fiscal_year FROM aggregateon_contracts_cumulative_spending where type_of_year = 'B' AND maximum_contract_amount IS NULL) b
WHERE a.original_agreement_id = b.original_agreement_id AND b.fiscal_year between starting_year and ending_year ;


SELECT * FROM aggregateon_contracts_cumulative_spending where type_of_year = 'B' AND coalesce(agency_id, 0) = 0 ;

CREATE TABLE mtr_test as select original_agreement_id, fiscal_year FROM aggregateon_contracts_cumulative_spending where type_of_year = 'B' AND coalesce(agency_id, 0) = 0 AND master_agreement_yn = 'N' DISTRIBUTED BY (original_agreement_id);

SELECT * from mtr_test

select * from disbursement_line_item_details where agreement_id in (select original_agreement_id from mtr_test where fiscal_year = 2010) and fiscal_year <= 2010

select * from disbursement_line_item_details where agreement_id in (select original_agreement_id from mtr_test where fiscal_year = 2011) and fiscal_year <= 2011

select * from aggregateon_contracts_cumulative_spending where original_agreement_id = 231976 and fiscal_year = 2011 

select * from  disbursement_line_item_details where agreement_id = 231976 and fiscal_year <= 2011

select * from disbursement_line_item_details a JOIN
mtr_test b
ON a.agreement_id = b.original_agreement_id AND b.fiscal_year <= a.fiscal_year ;


-- comparing aggregateon_contracts_cumulative_spending_all_years with aggregateon_contracts_cumulative_spending

select original_agreement_id, max(fiscal_year) from aggregateon_contracts_cumulative_spending where status_flag = 'R' and type_of_year in ('B','C') group by 1 ;   --- 40010


SELECT  a.original_agreement_id, 
	a.document_code_id, 
	master_agreement_yn, 
	MIN(a.description) as description, 
	MIN(a.contract_number) as contract_number, 
	MIN(a.vendor_id) as vendor_id, 
	MIN(a.award_method_id) as award_method_id, 
	MIN(CASE WHEN a.master_agreement_yn = 'N' THEN funding_agency_id WHEN a.master_agreement_yn = 'Y' THEN  document_agency_id ELSE NULL END) as agency_id ,
	MIN(a.original_contract_amount) as original_contract_amount,
	MIN(a.maximum_contract_amount) as maximum_contract_amount,
	SUM(a.check_amount) as spending_amount,
	MIN(a.dollar_difference) as dollar_difference,
	MIN(a.percent_difference) as percent_difference,
	'R' as status_flag
	FROM
(SELECT  a.original_agreement_id, 
	a.document_code_id, 
	a.master_agreement_yn, 
	a.description, 
	a.contract_number, 
	a.vendor_id, 
	a.award_method_id, 
	last_value(b.agency_id) over (partition by a.original_agreement_id  ORDER BY b.check_eft_issued_date_id asc) as funding_agency_id,
	a.agency_id as document_agency_id,
	a.original_contract_amount,
	a.maximum_contract_amount,
	b.check_amount,
	a.dollar_difference,
	a.percent_difference
FROM agreement_snapshot a 
LEFT JOIN disbursement_line_item_details  b ON a.original_agreement_id = b.agreement_id
 WHERE latest_flag = 'Y' and registered_year >= 2010 ) a
 GROUP BY 1,2,3 ;  -- 40010


 select original_agreement_id, max(fiscal_year) from aggregateon_contracts_cumulative_spending where status_flag = 'A' and type_of_year = 'C' group by 1 ;  -- 120280

 -- The above number is until the current fiscal or calendar year.

 SELECT  a.original_agreement_id, 
	a.document_code_id, 
	master_agreement_yn, 
	MIN(a.description) as description, 
	MIN(a.contract_number) as contract_number, 
	MIN(a.vendor_id) as vendor_id, 
	MIN(a.award_method_id) as award_method_id, 
	MIN(CASE WHEN a.master_agreement_yn = 'N' THEN funding_agency_id WHEN a.master_agreement_yn = 'Y' THEN  document_agency_id ELSE NULL END) as agency_id ,
	MIN(a.original_contract_amount) as original_contract_amount,
	MIN(a.maximum_contract_amount) as maximum_contract_amount,
	SUM(a.check_amount) as spending_amount,
	MIN(a.dollar_difference) as dollar_difference,
	MIN(a.percent_difference) as percent_difference,
	'A' as status_flag
	FROM
(SELECT  a.original_agreement_id, 
	a.document_code_id, 
	a.master_agreement_yn, 
	a.description, 
	a.contract_number, 
	a.vendor_id, 
	a.award_method_id, 
	last_value(b.agency_id) over (partition by a.original_agreement_id  ORDER BY b.check_eft_issued_date_id asc) as funding_agency_id,
	a.agency_id as document_agency_id,
	a.original_contract_amount,
	a.maximum_contract_amount,
	b.check_amount,
	a.dollar_difference,
	a.percent_difference
FROM agreement_snapshot a 
LEFT JOIN disbursement_line_item_details  b ON a.original_agreement_id = b.agreement_id
 WHERE latest_flag = 'Y' and (effective_begin_year >= 2010 OR effective_end_year >= 2010 )) a
 GROUP BY 1,2,3 ; -- 165536

 -- The above number represents all the contracts which are active any year from 2010 and also counts the contracts that are beyond current fiscal or calendar year
 
 

SELECT  original_agreement_id,
	fiscal_year,
	year_id,
	document_code_id,	
	master_agreement_yn,
	MIN(description),
	MIN(contract_number),
	MIN(vendor_id),
	MIN(award_method_id),
	MIN(case when master_agreement_yn = 'N'  THEN funding_agency_id WHEN  master_agreement_yn = 'Y'  THEN document_agency_id ELSE 0 END) as agency_id,
	MIN(original_contract_amount),
	MIN(maximum_contract_amount),
	SUM(check_amount),
	MIN(dollar_difference),
	MIN(percent_difference),
	'A' as status_flag,
	'B' as type_of_year
FROM
(
	SELECT  a.original_agreement_id,
		a.fiscal_year,
		ry.year_id,
		document_code_id,
		a.master_agreement_yn,
		description,
		contract_number,
		vendor_id,
		award_method_id,
		original_contract_amount,
		maximum_contract_amount,
		dollar_difference,
		percent_difference,
		b.fiscal_year as spending_fiscal_year,
		a.agency_id as document_agency_id,
		b.check_amount,
		last_value(partition by a.original_agreement_id,a.fiscal_year order by b.fiscal_year desc ) as funding_agency_id
	FROM 	agreement_snapshot_expanded a 
	LEFT JOIN ref_year ry ON a.fiscal_year = ry.year_value 
	LEFT JOIN mid_aggregateon_disbursement_spending_year b ON a.original_agreement_id = b.original_agreement_id AND a.fiscal_year >= b.fiscal_year AND b.type_of_year ='B'
	WHERE  a.status_flag='A' and a.original_agreement_id = 231976
) expanded_tbl 
GROUP BY 1,2,3,4,5;


SELECT * from aggregateon_contracts_cumulative_spending where original_agreement_id = 902 and type_of_year = 'B' and status_flag = 'R'

select * from disbursement_line_item_details where master_agreement_id = 902 and fiscal_year <= 2011



select agreement_id, count(distinct agency_id) from disbursement_line_item_details group by 1 having count(distinct agency_id) > 5

update disbursement_line_item_details set check_amount = 9999999999 where disbursement_line_item_id = 1918062;

select * from disbursement_line_item_details where agreement_id = 408054 order by fiscal_year, check_eft_issued_date, agency_id

select * from agreement_snapshot where original_agreement_id = 408054

select * from agreement_snapshot_expanded where status_flag = 'A' and original_agreement_id = 408054


SELECT  original_agreement_id,
	fiscal_year,
	year_id,
	document_code_id,	
	master_agreement_yn,
	MIN(description),
	MIN(contract_number),
	MIN(vendor_id),
	MIN(award_method_id),
	MIN(case when master_agreement_yn = 'N' THEN funding_agency_id WHEN  master_agreement_yn = 'Y'  THEN document_agency_id ELSE 0 END) as agency_id,
	MIN(original_contract_amount),
	MIN(maximum_contract_amount),
	SUM(check_amount),
	MIN(dollar_difference),
	MIN(percent_difference),
	'A' as status_flag,
	'B' as type_of_year
FROM
(
	SELECT  a.original_agreement_id,
		a.fiscal_year,
		ry.year_id,
		document_code_id,
		a.master_agreement_yn,
		description,
		contract_number,
		vendor_id,
		award_method_id,
		original_contract_amount,
		maximum_contract_amount,
		dollar_difference,
		percent_difference,
		b.fiscal_year as spending_fiscal_year,
		b.agency_id as funding_agency_id1,
		a.agency_id as document_agency_id,
		b.check_amount,
		last_value(b.agency_id) over (partition by a.original_agreement_id,a.fiscal_year  ORDER BY b.fiscal_year asc) as funding_agency_id
	FROM 	agreement_snapshot_expanded a 
	LEFT JOIN ref_year ry ON a.fiscal_year = ry.year_value 
	LEFT JOIN mid_aggregateon_disbursement_spending_year b ON a.original_agreement_id = b.original_agreement_id AND a.fiscal_year >= b.fiscal_year AND b.type_of_year ='B'
	WHERE  a.status_flag='A' and a.original_agreement_id = 408054 order by fiscal_year
) expanded_tbl 
GROUP BY 1,2,3,4,5;

select * from mid_aggregateon_disbursement_spending_year where original_agreement_id = 408054 and type_of_year = 'B'

select * from aggregateon_contracts_cumulative_spending where original_agreement_id = 408054 and type_of_year = 'B'

select description, contract_number, agency_id, original_contract_amount, maximum_contract_amount, spending_amount from aggregateon_contracts_cumulative_spending where status_flag = 'A' and type_of_year = 'B' and fiscal_year = 2011 AND spending_amount IS NOT NULL AND agency_id = 104 order by spending_amount desc limit 5


