widget_name,aggregate_table_name,query
SpendingByCOAEntitiesAndFiscalYear,aggregateon_spending_coa_entities,"SELECT department_id,agency_id,
       spending_category_id,
       expenditure_object_id,       
       month_id,
       year_id,
       sum(total_spending_amount) total_spending_amount,
       sum(contract_amount) total_contract_amount
  FROM (SELECT agency_id,
               (CASE
                   WHEN     COALESCE(master_agreement_id, agreement_id) > 0
                        AND fund_class_id = 400
                   THEN
                      1
                   WHEN     COALESCE(master_agreement_id, agreement_id) > 0
                        AND fund_class_id <> 400
                   THEN
                      2
                   ELSE
                      3
                END)
                  AS spending_category_id,
               expenditure_object_id,
               department_id,
               COALESCE(master_agreement_id, agreement_id) AS agreement_id,
               check_eft_issued_cal_month_id AS month_id,
               check_eft_issued_nyc_year_id AS year_id,
               sum(check_amount) AS total_spending_amount,
               MIN(
                  CASE
                     WHEN master_agreement_id > 0 THEN maximum_spending_limit
                     WHEN agreement_id > 0 THEN maximum_contract_amount
                     ELSE 0
                  END)
                  AS contract_amount
          FROM fact_disbursement_line_item a
  GROUP BY 1,2,3,4,5,6,7) X
  GROUP BY 1,2,3,4,5,6"
SpendingByVendorId,aggregateon_spending_vendor,"SELECT vendor_id, agency_id,       
       year_id,
       sum(total_spending_amount) total_spending_amount,
       sum(contract_amount) total_contract_amount
  FROM (SELECT agency_id,
               vendor_id,
               check_eft_issued_nyc_year_id AS year_id,
               COALESCE(master_agreement_id, agreement_id) AS agreement_id,
               sum(check_amount) AS total_spending_amount,
               MIN(
                  CASE
                     WHEN master_agreement_id > 0 THEN maximum_spending_limit
                     WHEN agreement_id > 0 THEN maximum_contract_amount
                     ELSE 0
                  END)
                  AS contract_amount
          FROM    fact_disbursement_line_item a
GROUP BY 1,2,3,4) X
GROUP BY 1,2,3"
SpendingByContractId,aggregateon_spending_contract,"SELECT a.agreement_id, 
	   a.vendor_id,
	   a.agency_id,
       a.description,
       b.check_eft_issued_nyc_year_id AS year_id,
       sum(b.check_amount) AS total_spending_amount,
       MIN(a.maximum_contract_amount) AS totla_contract_amount
  FROM fact_agreement a
       JOIN fact_disbursement_line_item b
          ON COALESCE(a.master_agreement_id, a.agreement_id) =
                COALESCE(b.master_agreement_id, b.agreement_id)
GROUP BY 1,2,3,4,5"