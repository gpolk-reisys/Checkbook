<statements>
    <!-- Widgets -->
    <statement name="GetChecks" datasource="checkbook">
        <param name="year" />
        <param name="mwbe" />
        <sql>
            SELECT
            check_eft_issued_date as issue_date,
            vendor_name,
            agency_name,
            check_amount,
            expenditure_object_name as expense_category,
            agency_id,
            vendor_id,
            expenditure_object_id,
            department_name
            FROM disbursement_line_item_details
            <where>
                <exp op="AND">
                    <exp op="=" dbField="check_eft_issued_nyc_year_id" paramName="year" />
                    <exp op="IN" dbField="minority_type_id" paramName="mwbe" />
                </exp>
            </where>
        </sql>
    </statement>
    <statement name="GetAgencies" datasource="checkbook">
        <param name="year" />
        <param name="yeartype" />
        <param name="mwbe" />
        <sql>
            SELECT
            a.agency_id,
            b.agency_name,
            SUM(total_spending_amount) as check_amount,
            SUM(total_spending_amount)/MAX(total.check_amount)*100 as percent_spending
            FROM aggregateon_mwbe_spending_coa_entities a
            JOIN ref_agency b ON b.agency_id = a.agency_id
            JOIN
            (
                SELECT SUM(total_spending_amount) AS check_amount
                FROM aggregateon_mwbe_spending_coa_entities
                <where>
                    <exp op="AND">
                        <exp op="=" dbField="year_id" paramName="year" />
                        <exp op="=" dbField="type_of_year" paramName="yeartype" />
                        <exp op="IN" dbField="minority_type_id" paramName="mwbe" />
                    </exp>
                </where>
            ) total on 1 = 1
            <where>
                <exp op="AND">
                    <exp op="=" dbField="a.year_id" paramName="year" />
                    <exp op="=" dbField="a.type_of_year" paramName="yeartype" />
                    <exp op="IN" dbField="a.minority_type_id" paramName="mwbe" />
                </exp>
            </where>
            GROUP BY a.agency_id,b.agency_name
        </sql>
    </statement>
    <statement name="GetExpenseCategories" datasource="checkbook">
        <param name="year" />
        <param name="yeartype" />
        <param name="mwbe" />
        <sql>
            SELECT
            b.expenditure_object_id as expense_category_id,
            b.original_expenditure_object_name as expense_category_name,
            SUM(total_spending_amount) as check_amount,
            SUM(total_spending_amount)/MAX(total.check_amount)*100 as percent_spending
            FROM aggregateon_mwbe_spending_coa_entities a
            JOIN ref_expenditure_object b ON b.expenditure_object_id = a.expenditure_object_id
            JOIN
            (
                SELECT SUM(total_spending_amount) AS check_amount
                FROM aggregateon_mwbe_spending_coa_entities
                <where>
                    <exp op="AND">
                        <exp op="=" dbField="year_id" paramName="year" />
                        <exp op="=" dbField="type_of_year" paramName="yeartype" />
                        <exp op="IN" dbField="minority_type_id" paramName="mwbe" />
                    </exp>
                </where>
            ) total on 1 = 1
            <where>
                <exp op="AND">
                    <exp op="=" dbField="a.year_id" paramName="year" />
                    <exp op="=" dbField="a.type_of_year" paramName="yeartype" />
                    <exp op="IN" dbField="a.minority_type_id" paramName="mwbe" />
                </exp>
            </where>
            GROUP BY b.expenditure_object_id,b.original_expenditure_object_name
        </sql>
    </statement>
    <statement name="GetPrimeVendors" datasource="checkbook">
        <param name="year" />
        <param name="yeartype" />
        <param name="mwbe" />
        <sql>
            SELECT
            a.vendor_id,
            b.legal_name as prime_vendor_name,
            CASE
                WHEN minority_type_id = 2 THEN 'Black American'
                WHEN minority_type_id = 3 THEN 'Hispanic American'
                WHEN minority_type_id IN (4,5) THEN 'Asian American'
                WHEN minority_type_id = 9 THEN 'Women'
            END as mwbe_category,
            SUM(COALESCE(total_spending_amount,0)) as check_amount,
            SUM(total_spending_amount)/MAX(total.check_amount)*100 as percent_spending,
            MAX(COALESCE(total_contract_amount,0)) as total_contract_amount
            FROM aggregateon_mwbe_spending_vendor a
            JOIN vendor b ON b.vendor_id = a.vendor_id
            JOIN
            (
                SELECT SUM(total_spending_amount) AS check_amount
                FROM aggregateon_mwbe_spending_vendor
                <where>
                    <exp op="AND">
                        <exp op="=" dbField="year_id" paramName="year" />
                        <exp op="=" dbField="type_of_year" paramName="yeartype" />
                        <exp op="IN" dbField="minority_type_id" paramName="mwbe" />
                        <exp op="IS" dbField="spending_category_id">NULL</exp>
                    </exp>
                </where>
            ) total on 1 = 1
            <where>
                <exp op="AND">
                    <exp op="=" dbField="a.year_id" paramName="year" />
                    <exp op="=" dbField="a.type_of_year" paramName="yeartype" />
                    <exp op="IN" dbField="a.minority_type_id" paramName="mwbe" />
                    <exp op="IS" dbField="a.spending_category_id">NULL</exp>
                </exp>
            </where>
            GROUP BY a.vendor_id, b.legal_name, mwbe_category
        </sql>
    </statement>
    <statement name="GetSubVendors" datasource="checkbook">
        <param name="year" />
        <param name="yeartype" />
        <param name="mwbe" />
        <sql>
            SELECT
            a.vendor_id,
            b.legal_name as sub_vendor_name,
            CASE
                WHEN minority_type_id = 2 THEN 'Black American'
                WHEN minority_type_id = 3 THEN 'Hispanic American'
                WHEN minority_type_id IN (4,5) THEN 'Asian American'
                WHEN minority_type_id = 9 THEN 'Women'
            END as mwbe_category,
            SUM(COALESCE(total_spending_amount,0)) AS check_amount,
            SUM(total_spending_amount)/MAX(total.check_amount)*100 as percent_spending,
            SUM(COALESCE(total_contract_amount,0)) AS total_sub_contract_amount,
            SUM(total_sub_contracts) AS number_sub_contracts,
            SUM(total_spending_amount) AS ytd_spending
            FROM aggregateon_subven_spending_vendor a
            JOIN subvendor b ON b.vendor_id = a.vendor_id
            JOIN
            (
                SELECT SUM(total_spending_amount) AS check_amount
                FROM aggregateon_subven_spending_vendor
                <where>
                    <exp op="AND">
                        <exp op="=" dbField="year_id" paramName="year" />
                        <exp op="=" dbField="type_of_year" paramName="yeartype" />
                        <exp op="IN" dbField="minority_type_id" paramName="mwbe" />
                        <exp op="=" dbField="is_all_categories">'Y'</exp>
                    </exp>
                </where>
            ) total on 1 = 1
            <where>
                <exp op="AND">
                    <exp op="=" dbField="a.year_id" paramName="year" />
                    <exp op="=" dbField="a.type_of_year" paramName="yeartype" />
                    <exp op="IN" dbField="a.minority_type_id" paramName="mwbe" />
                    <exp op="=" dbField="is_all_categories">'Y'</exp>
                </exp>
            </where>
            GROUP BY a.vendor_id, b.legal_name, mwbe_category
        </sql>
    </statement>
    <statement name="GetContracts" datasource="checkbook">
        <param name="year" />
        <param name="yeartype" />
        <param name="mwbe" />
        <sql>
            SELECT
            a.document_id as contract_number,
            a.description as contract_purpose,
            b.agency_name,
            c.legal_name as prime_vendor_name,
            SUM(COALESCE(total_spending_amount,0)) AS check_amount,
            MAX(COALESCE(total_contract_amount,0)) AS total_contract_amount
            FROM aggregateon_mwbe_spending_contract a
            JOIN ref_agency b ON b.agency_id = a.agency_id
            JOIN vendor c ON c.vendor_id = a.vendor_id
            <where>
                <exp op="AND">
                    <exp op="=" dbField="a.year_id" paramName="year" />
                    <exp op="=" dbField="a.type_of_year" paramName="yeartype" />
                    <exp op="IN" dbField="a.minority_type_id" paramName="mwbe" />
                </exp>
            </where>
            GROUP BY a.document_id, a.description, b.agency_name, c.legal_name
        </sql>
    </statement>
    <statement name="GetSpendingByIndustries" datasource="checkbook">
        <param name="year" />
        <param name="yeartype" />
        <param name="mwbe" />
        <sql>
            SELECT
            a.industry_type_id,
            b.industry_type_name,
            SUM(total_spending_amount) as check_amount,
            SUM(total_spending_amount)/MAX(total.check_amount)*100 as percent_spending
            FROM aggregateon_mwbe_spending_coa_entities a
            JOIN ref_industry_type b ON b.industry_type_id = a.industry_type_id
            JOIN
            (
                SELECT SUM(total_spending_amount) AS check_amount
                FROM aggregateon_mwbe_spending_coa_entities
                <where>
                    <exp op="AND">
                        <exp op="=" dbField="year_id" paramName="year" />
                        <exp op="=" dbField="type_of_year" paramName="yeartype" />
                        <exp op="IN" dbField="minority_type_id" paramName="mwbe" />
                        <exp op="IS NOT" dbField="industry_type_id">NULL</exp>
                    </exp>
                </where>
            ) total on 1 = 1
            <where>
                <exp op="AND">
                    <exp op="=" dbField="year_id" paramName="year" />
                    <exp op="=" dbField="a.type_of_year" paramName="yeartype" />
                    <exp op="IN" dbField="minority_type_id" paramName="mwbe" />
                    <exp op="IS NOT" dbField="a.industry_type_id">NULL</exp>
                </exp>
            </where>
            GROUP BY a.industry_type_id,b.industry_type_name
        </sql>
    </statement>
    <!-- Charts -->
    <statement name="GetMwbeSpendingByYears" datasource="checkbook">
        <param name="year" />
        <param name="yeartype" />
        <param name="mwbe" />
        <sql>
            SELECT
            year_value as fiscal_year,
            SUM(CASE WHEN minority_type_id IN (4,5) THEN total_spending ELSE 0 END) AS asian_american_spending,
            SUM(CASE WHEN minority_type_id = 2 THEN total_spending ELSE 0 END) AS black_american_spending,
            SUM(CASE WHEN minority_type_id = 3 THEN total_spending ELSE 0 END) AS hispanic_american_spending,
            SUM(CASE WHEN minority_type_id = 9 THEN total_spending ELSE 0 END) AS women_spending,
            SUM(CASE WHEN minority_type_id IN (2, 3, 4, 5, 9) THEN total_spending ELSE 0 END) AS total_mwbe_spending
            FROM
            (
                SELECT year.year_value,minority_type_id,
                SUM(COALESCE(total_spending_amount,0)) as total_spending
                FROM aggregateon_mwbe_spending_coa_entities a
                JOIN ref_year year on year.year_id = a.year_id
                <where>
                    <exp op="AND">
                        <exp op="IN" dbField="a.year_id" paramName="year" />
                        <exp op="=" dbField="a.type_of_year" paramName="yeartype" />
                        <exp op="IN" dbField="a.minority_type_id" paramName="mwbe" />
                    </exp>
                </where>
                GROUP BY a.minority_type_id,year.year_value
            ) spending
            GROUP BY fiscal_year
        </sql>
    </statement>
    <statement name="GetMwbeVendorSpendingByZipCodes" datasource="checkbook">
        <sql>
            SELECT 10004 as zipcode, 'Manhattan' as borough, 7 as mwbe_vendor_count, 13.5 as ytd_spending UNION ALL
            SELECT 10003 as zipcode, 'Manhattan' as borough, 9 as mwbe_vendor_count, 9.34 as ytd_spending UNION ALL
            SELECT 10007 as zipcode, 'Manhattan' as borough, 6 as mwbe_vendor_count, 8.06 as ytd_spending UNION ALL
            SELECT 10005 as zipcode, 'Manhattan' as borough, 2 as mwbe_vendor_count, 7.5 as ytd_spending UNION ALL
            SELECT 10002 as zipcode, 'Manhattan' as borough, 5 as mwbe_vendor_count, 1.1 as ytd_spending UNION ALL
            SELECT 10006 as zipcode, 'Manhattan' as borough, 3 as mwbe_vendor_count, 1.06 as ytd_spending

        </sql>
    </statement>
    <!-- Common -->
    <statement name="GetSpendingByCategory" datasource="checkbook">
        <param name="year" />
        <param name="yeartype" />
        <param name="mwbe" />
        <sql>
            SELECT
            a.spending_category_id,
            a.display_name as spending_category_name,
            replace(a.display_name, 'Spending', '') as spending_category,
            COALESCE(total_spending_amount,0) as total_spending_amount
            FROM ref_spending_category a
            LEFT JOIN
            (
                SELECT spending_category_id, SUM(COALESCE(total_spending_amount,0)) AS total_spending_amount
                FROM aggregateon_mwbe_spending_coa_entities
                <where>
                    <exp op="AND">
                        <exp op="=" dbField="year_id" paramName="year" />
                        <exp op="=" dbField="type_of_year" paramName="yeartype" />
                        <exp op="IN" dbField="minority_type_id" paramName="mwbe" />
                    </exp>
                </where>
                GROUP BY spending_category_id

                UNION

                SELECT 6 as spending_category_id, SUM(COALESCE(total_spending_amount,0)) AS total_spending_amount
                FROM aggregateon_mwbe_spending_coa_entities
                <where>
                    <exp op="AND">
                        <exp op="=" dbField="year_id" paramName="year" />
                        <exp op="=" dbField="type_of_year" paramName="yeartype" />
                        <exp op="IN" dbField="minority_type_id" paramName="mwbe" />
                    </exp>
                </where>
            ) b on b.spending_category_id = a.spending_category_id
            ORDER BY a.display_order
        </sql>
    </statement>
    <statement name="GetSpendingByDomain" datasource="checkbook">
        <param name="year" />
        <param name="yeartype" />
        <sql>

            SELECT * FROM (

            SELECT 'Budget' domain, 1 as display_order,
            SUM(COALESCE(current_budget_amount,0)) AS total_amount
            FROM budget
            <where>
                <exp op="AND">
                    <exp op="=" dbField="budget_fiscal_year_id" paramName="year" />
                </exp>
            </where>

            UNION

            SELECT 'Revenue' domain, 2 as display_order,
            SUM(COALESCE(posting_amount,0)) AS total_amount
            FROM revenue_details
            <where>
                <exp op="AND">
                    <exp op="=" dbField="budget_fiscal_year_id" paramName="year" />
                </exp>
            </where>

            UNION

            SELECT 'Spending' domain, 3 as display_order,
            SUM(COALESCE(total_spending_amount,0)) AS total_spending_amount
            FROM aggregateon_mwbe_spending_coa_entities
            <where>
                <exp op="AND">
                    <exp op="=" dbField="year_id" paramName="year" />
                </exp>
            </where>

            UNION

            SELECT 'Contracts' domain, 4 as display_order,
            SUM(COALESCE(maximum_contract_amount,0)) AS total_spending_amount
            FROM aggregateon_all_contracts_cumulative_spending a
            JOIN ref_document_code b ON b.document_code_id = a.document_code_id
            <where>
                <exp op="AND">
                    <exp op="=" dbField="fiscal_year_id" paramName="year" />
                    <exp op="=" dbField="type_of_year" paramName="yeartype" />
                    <exp op="IN" dbField="document_code">('CT1', 'CTA1', 'RCT1', 'MA1')</exp>
                    <exp op="=" dbField="status_flag">'R'</exp>
                </exp>
            </where>

            UNION

            SELECT 'Payroll' domain, 5 as display_order,
            SUM(COALESCE(gross_pay,0)) AS total_amount
            FROM payroll
            <where>
                <exp op="AND">
                    <exp op="=" dbField="fiscal_year_id" paramName="year" />
                </exp>
            </where>
            ) domains
            ORDER BY display_order
        </sql>
    </statement>
    <statement name="GetSpendingBySubDomain" datasource="checkbook">
        <param name="year" />
        <param name="yeartype" />
        <sql>
            SELECT 'ALL (Citywide)' as sub_domain, 1 as display_order,
            SUM(COALESCE(total_spending_amount,0)) AS total_spending_amount
            FROM aggregateon_mwbe_spending_coa_entities
            <where>
                <exp op="AND">
                    <exp op="=" dbField="year_id" paramName="year" />
                    <exp op="=" dbField="type_of_year" paramName="yeartype" />
                </exp>
            </where>
            UNION
            SELECT 'M/WBE' as sub_domain, 3 as display_order,
            SUM(COALESCE(total_spending_amount,0)) AS total_spending_amount
            FROM aggregateon_mwbe_spending_coa_entities
            <where>
                <exp op="AND">
                    <exp op="=" dbField="year_id" paramName="year" />
                    <exp op="=" dbField="type_of_year" paramName="yeartype" />
                    <exp op="IN" dbField="minority_type_id">(2,3,4,5,9)</exp>
                </exp>
            </where>
            UNION
            SELECT 'M/WBE (Sub Vendor)' as sub_domain, 4 as display_order,
            SUM(COALESCE(total_spending_amount,0)) AS total_spending_amount
            FROM aggregateon_subven_spending_coa_entities
            <where>
                <exp op="AND">
                    <exp op="=" dbField="year_id" paramName="year" />
                    <exp op="=" dbField="type_of_year" paramName="yeartype" />
                    <exp op="IN" dbField="minority_type_id">(2,3,4,5,9)</exp>
                </exp>
            </where>
            UNION
            SELECT 'Sub Vendors' as sub_domain, 5 as display_order,
            SUM(COALESCE(total_spending_amount,0)) AS total_spending_amount
            FROM aggregateon_subven_spending_coa_entities
            <where>
                <exp op="AND">
                    <exp op="=" dbField="year_id" paramName="year" />
                    <exp op="=" dbField="type_of_year" paramName="yeartype" />
                </exp>
            </where>
        </sql>
    </statement>
</statements>